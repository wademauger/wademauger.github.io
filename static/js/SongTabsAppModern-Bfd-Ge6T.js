import{U as ct,V as Ue,W as ne,X as Fe,Y as Ce,Z as Re,$ as Oe,a0 as Qe,a1 as dt,a2 as Le,a3 as ut,a4 as ht,a5 as ze,a6 as tt,b as u,a7 as mt,a8 as ft,j as t,x as Me,k as st,f as se,R as _e,S as je,a9 as gt,aa as pt,M as rt,ab as yt,ac as bt,ad as nt,ae as vt,af as he,ag as me,ah as Ee,B as oe,s as ie,ai as fe,aj as St,ak as xt,al as Be,am as We,z as wt,an as Ke,ao as He,ap as Ct,aq as Je,ar as jt,as as At,at as Nt,au as Lt}from"./index-C5ig_0BN.js";import{d as Et,e as Ve,s as kt,K as Tt,h as It,b as Pt,c as at,k as Dt,D as Ft,f as Rt,S as Ot,v as _t,i as it,g as $t,u as Mt,C as Gt,l as Ut,j as Qt,F as zt,a as Bt,B as Wt,T as Kt,P as Ht,A as Jt}from"./sortable.esm-B_vcb_dX.js";import{S as Vt}from"./index-G2vkQwzc.js";var qt=class extends ct{constructor(e,s){super(),this.options=s,this.#s=e,this.#n=null,this.#r=Ue(),this.bindMethods(),this.setOptions(s)}#s;#e=void 0;#f=void 0;#t=void 0;#i;#d;#r;#n;#g;#u;#h;#o;#l;#a;#m=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(this.#e.addObserver(this),qe(this.#e,this.options)?this.#c():this.updateResult(),this.#v())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return $e(this.#e,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return $e(this.#e,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#S(),this.#x(),this.#e.removeObserver(this)}setOptions(e){const s=this.options,n=this.#e;if(this.options=this.#s.defaultQueryOptions(e),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof ne(this.options.enabled,this.#e)!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");this.#w(),this.#e.setOptions(this.options),s._defaulted&&!Fe(this.options,s)&&this.#s.getQueryCache().notify({type:"observerOptionsUpdated",query:this.#e,observer:this});const r=this.hasListeners();r&&Ye(this.#e,n,this.options,s)&&this.#c(),this.updateResult(),r&&(this.#e!==n||ne(this.options.enabled,this.#e)!==ne(s.enabled,this.#e)||Ce(this.options.staleTime,this.#e)!==Ce(s.staleTime,this.#e))&&this.#p();const a=this.#y();r&&(this.#e!==n||ne(this.options.enabled,this.#e)!==ne(s.enabled,this.#e)||a!==this.#a)&&this.#b(a)}getOptimisticResult(e){const s=this.#s.getQueryCache().build(this.#s,e),n=this.createResult(s,e);return Xt(this,n)&&(this.#t=n,this.#d=this.options,this.#i=this.#e.state),n}getCurrentResult(){return this.#t}trackResult(e,s){return new Proxy(e,{get:(n,r)=>(this.trackProp(r),s?.(r),r==="promise"&&!this.options.experimental_prefetchInRender&&this.#r.status==="pending"&&this.#r.reject(new Error("experimental_prefetchInRender feature flag is not enabled")),Reflect.get(n,r))})}trackProp(e){this.#m.add(e)}getCurrentQuery(){return this.#e}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){const s=this.#s.defaultQueryOptions(e),n=this.#s.getQueryCache().build(this.#s,s);return n.fetch().then(()=>this.createResult(n,s))}fetch(e){return this.#c({...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#t))}#c(e){this.#w();let s=this.#e.fetch(this.options,e);return e?.throwOnError||(s=s.catch(Re)),s}#p(){this.#S();const e=Ce(this.options.staleTime,this.#e);if(Oe||this.#t.isStale||!Qe(e))return;const n=dt(this.#t.dataUpdatedAt,e)+1;this.#o=Le.setTimeout(()=>{this.#t.isStale||this.updateResult()},n)}#y(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(this.#e):this.options.refetchInterval)??!1}#b(e){this.#x(),this.#a=e,!(Oe||ne(this.options.enabled,this.#e)===!1||!Qe(this.#a)||this.#a===0)&&(this.#l=Le.setInterval(()=>{(this.options.refetchIntervalInBackground||ut.isFocused())&&this.#c()},this.#a))}#v(){this.#p(),this.#b(this.#y())}#S(){this.#o&&(Le.clearTimeout(this.#o),this.#o=void 0)}#x(){this.#l&&(Le.clearInterval(this.#l),this.#l=void 0)}createResult(e,s){const n=this.#e,r=this.options,a=this.#t,i=this.#i,o=this.#d,x=e!==n?e.state:this.#f,{state:N}=e;let j={...N},d=!1,p;if(s._optimisticResults){const O=this.hasListeners(),G=!O&&qe(e,s),W=O&&Ye(e,n,s,r);(G||W)&&(j={...j,...ht(N.data,e.options)}),s._optimisticResults==="isRestoring"&&(j.fetchStatus="idle")}let{error:y,errorUpdatedAt:v,status:A}=j;p=j.data;let g=!1;if(s.placeholderData!==void 0&&p===void 0&&A==="pending"){let O;a?.isPlaceholderData&&s.placeholderData===o?.placeholderData?(O=a.data,g=!0):O=typeof s.placeholderData=="function"?s.placeholderData(this.#h?.state.data,this.#h):s.placeholderData,O!==void 0&&(A="success",p=ze(a?.data,O,s),d=!0)}if(s.select&&p!==void 0&&!g)if(a&&p===i?.data&&s.select===this.#g)p=this.#u;else try{this.#g=s.select,p=s.select(p),p=ze(a?.data,p,s),this.#u=p,this.#n=null}catch(O){this.#n=O}this.#n&&(y=this.#n,p=this.#u,v=Date.now(),A="error");const F=j.fetchStatus==="fetching",M=A==="pending",k=A==="error",_=M&&F,w=p!==void 0,$={status:A,fetchStatus:j.fetchStatus,isPending:M,isSuccess:A==="success",isError:k,isInitialLoading:_,isLoading:_,data:p,dataUpdatedAt:j.dataUpdatedAt,error:y,errorUpdatedAt:v,failureCount:j.fetchFailureCount,failureReason:j.fetchFailureReason,errorUpdateCount:j.errorUpdateCount,isFetched:j.dataUpdateCount>0||j.errorUpdateCount>0,isFetchedAfterMount:j.dataUpdateCount>x.dataUpdateCount||j.errorUpdateCount>x.errorUpdateCount,isFetching:F,isRefetching:F&&!M,isLoadingError:k&&!w,isPaused:j.fetchStatus==="paused",isPlaceholderData:d,isRefetchError:k&&w,isStale:Ge(e,s),refetch:this.refetch,promise:this.#r,isEnabled:ne(s.enabled,e)!==!1};if(this.options.experimental_prefetchInRender){const O=E=>{$.status==="error"?E.reject($.error):$.data!==void 0&&E.resolve($.data)},G=()=>{const E=this.#r=$.promise=Ue();O(E)},W=this.#r;switch(W.status){case"pending":e.queryHash===n.queryHash&&O(W);break;case"fulfilled":($.status==="error"||$.data!==W.value)&&G();break;case"rejected":($.status!=="error"||$.error!==W.reason)&&G();break}}return $}updateResult(){const e=this.#t,s=this.createResult(this.#e,this.options);if(this.#i=this.#e.state,this.#d=this.options,this.#i.data!==void 0&&(this.#h=this.#e),Fe(s,e))return;this.#t=s;const n=()=>{if(!e)return!0;const{notifyOnChangeProps:r}=this.options,a=typeof r=="function"?r():r;if(a==="all"||!a&&!this.#m.size)return!0;const i=new Set(a??this.#m);return this.options.throwOnError&&i.add("error"),Object.keys(this.#t).some(o=>{const f=o;return this.#t[f]!==e[f]&&i.has(f)})};this.#C({listeners:n()})}#w(){const e=this.#s.getQueryCache().build(this.#s,this.options);if(e===this.#e)return;const s=this.#e;this.#e=e,this.#f=e.state,this.hasListeners()&&(s?.removeObserver(this),e.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#v()}#C(e){tt.batch(()=>{e.listeners&&this.listeners.forEach(s=>{s(this.#t)}),this.#s.getQueryCache().notify({query:this.#e,type:"observerResultsUpdated"})})}};function Yt(e,s){return ne(s.enabled,e)!==!1&&e.state.data===void 0&&!(e.state.status==="error"&&s.retryOnMount===!1)}function qe(e,s){return Yt(e,s)||e.state.data!==void 0&&$e(e,s,s.refetchOnMount)}function $e(e,s,n){if(ne(s.enabled,e)!==!1&&Ce(s.staleTime,e)!=="static"){const r=typeof n=="function"?n(e):n;return r==="always"||r!==!1&&Ge(e,s)}return!1}function Ye(e,s,n,r){return(e!==s||ne(r.enabled,e)===!1)&&(!n.suspense||e.state.status!=="error")&&Ge(e,n)}function Ge(e,s){return ne(s.enabled,e)!==!1&&e.isStaleByTime(Ce(s.staleTime,e))}function Xt(e,s){return!Fe(e.getCurrentResult(),s)}var ot=u.createContext(!1),Zt=()=>u.useContext(ot);ot.Provider;function es(){let e=!1;return{clearReset:()=>{e=!1},reset:()=>{e=!0},isReset:()=>e}}var ts=u.createContext(es()),ss=()=>u.useContext(ts),rs=(e,s)=>{(e.suspense||e.throwOnError||e.experimental_prefetchInRender)&&(s.isReset()||(e.retryOnMount=!1))},ns=e=>{u.useEffect(()=>{e.clearReset()},[e])},as=({result:e,errorResetBoundary:s,throwOnError:n,query:r,suspense:a})=>e.isError&&!s.isReset()&&!e.isFetching&&r&&(a&&e.data===void 0||mt(n,[e.error,r])),is=e=>{if(e.suspense){const n=a=>a==="static"?a:Math.max(a??1e3,1e3),r=e.staleTime;e.staleTime=typeof r=="function"?(...a)=>n(r(...a)):n(r),typeof e.gcTime=="number"&&(e.gcTime=Math.max(e.gcTime,1e3))}},os=(e,s)=>e.isLoading&&e.isFetching&&!s,ls=(e,s)=>e?.suspense&&s.isPending,Xe=(e,s,n)=>s.fetchOptimistic(e).catch(()=>{n.clearReset()});function cs(e,s,n){const r=Zt(),a=ss(),i=ft(),o=i.defaultQueryOptions(e);i.getDefaultOptions().queries?._experimental_beforeQuery?.(o),o._optimisticResults=r?"isRestoring":"optimistic",is(o),rs(o,a),ns(a);const f=!i.getQueryCache().get(o.queryHash),[x]=u.useState(()=>new s(i,o)),N=x.getOptimisticResult(o),j=!r&&e.subscribed!==!1;if(u.useSyncExternalStore(u.useCallback(d=>{const p=j?x.subscribe(tt.batchCalls(d)):Re;return x.updateResult(),p},[x,j]),()=>x.getCurrentResult(),()=>x.getCurrentResult()),u.useEffect(()=>{x.setOptions(o)},[o,x]),ls(o,N))throw Xe(o,x,a);if(as({result:N,errorResetBoundary:a,throwOnError:o.throwOnError,query:i.getQueryCache().get(o.queryHash),suspense:o.suspense}))throw N.error;return i.getDefaultOptions().queries?._experimental_afterQuery?.(o,N),o.experimental_prefetchInRender&&!Oe&&os(N,r)&&(f?Xe(o,x,a):i.getQueryCache().get(o.queryHash)?.promise)?.catch(Re).finally(()=>{x.updateResult()}),o.notifyOnChangeProps?N:x.trackResult(N)}function ds(e,s){return cs(e,qt)}const lt=({line:e,onSave:s,onCancel:n})=>{const[r,a]=u.useState(e||""),i=u.useRef(null);u.useEffect(()=>{i.current&&i.current.focus()},[]);const o=()=>{s(r)},f=x=>{x.key==="Enter"?o():x.key==="Escape"&&n()};return t.jsxs("div",{className:"lyric-line-editor",children:[t.jsx("input",{ref:i,type:"text",value:r,onChange:x=>a(x.target.value),onKeyDown:f,placeholder:"Enter lyrics with [Chord] notation...",className:"lyric-input"}),t.jsxs("div",{className:"editor-controls",children:[t.jsx("button",{onClick:o,className:"save-button",children:"Save"}),t.jsx("button",{onClick:n,className:"cancel-button",children:"Cancel"})]})]})},us=({line:e,index:s,id:n,editingLineIndex:r,editingEnabled:a,hoveredLineIndex:i,setHoveredLineIndex:o,handleEditLine:f,handleInsertAfter:x,handleDeleteLine:N,handleSaveLine:j,handleCancelEdit:d,renderLyricLine:p,isThisLinePending:y=!1,isDragDisabled:v=!1,isPendingDelete:A=!1,isAddingLine:g=!1,isPendingSave:F=!1})=>{const{attributes:M,listeners:k,setNodeRef:_,transform:w,transition:K,isDragging:$}=Mt({id:n,disabled:v}),O={transform:Gt.Transform.toString(w),transition:K,opacity:$?.5:A?.6:1};return t.jsx("div",{ref:_,style:O,className:`lyric-line ${A?"pending-delete":""}`,onMouseEnter:()=>o(s),onMouseLeave:()=>o(null),children:r===s&&!g&&a?t.jsx(lt,{line:e,onSave:G=>j(G,s),onCancel:d}):t.jsxs("div",{className:"lyric-line-row",children:[t.jsx("div",{className:"lyric-content",children:p(e)}),F&&t.jsxs("div",{className:"pending-badge pending-save",children:[t.jsx(je,{size:"small"}),t.jsx("span",{className:"pending-text",children:"Saving..."})]}),A&&t.jsxs("div",{className:"pending-badge pending-delete-badge",children:[t.jsx(je,{size:"small"}),t.jsx("span",{className:"pending-text",children:"Deleting..."})]}),i===s&&a&&!A&&t.jsxs("div",{className:"lyric-controls",children:[t.jsx("button",{className:"control-button edit",onClick:G=>{G.stopPropagation(),f(s)},title:"Edit this line",children:t.jsx(Ut,{})}),t.jsx("button",{className:"control-button insert",onClick:G=>{G.stopPropagation(),x(s)},title:"Insert new line after this line",children:t.jsx(it,{})}),t.jsx("button",{className:"control-button delete",onClick:G=>{G.stopPropagation(),N(s)},title:"Delete this line",children:t.jsx(at,{})}),t.jsx("div",{...v?{}:M,...v?{}:k,className:"drag-handle",title:v?"Drag disabled during update":"Drag to reorder",children:y?t.jsx(je,{size:"small"}):t.jsx(Qt,{})})]})]})})},hs=({song:e,onPinChord:s,onUpdateSong:n,artist:r,editingEnabled:a=!0})=>{const{message:i}=Me.useApp(),[o,f]=u.useState(null),[x,N]=u.useState(!1),[j,d]=u.useState(null),[p,y]=u.useState(0),[v,A]=u.useState(!1),[g,F]=u.useState(""),[M,k]=u.useState(new Set),[_,w]=u.useState(null),[K,$]=u.useState(null),[O,G]=u.useState(new Set),[W,E]=u.useState(!1),[U,D]=u.useState(!1),[z,te]=u.useState(!1),q=st(),ee=se(l=>l.chords.currentInstrument),be=se(l=>l.chords.transposeBy?.[e.title]||0),ve=se(l=>l.chords.chordFingerings),c=se(l=>l.songs.isGoogleDriveConnected),b=Et(Ve(It),Ve(Tt,{coordinateGetter:kt})),R=l=>{const C=/\[(.*?)\]/g,I=[];return l?.forEach(L=>{let P;for(;(P=C.exec(L))!==null;)I.includes(P[1])||I.push(P[1])}),I},T=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],X={Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#",Bb:"A#"};function Z(l,C){if(l.includes("/")){const[ae,Ne]=l.split("/"),Pe=Z(ae,C),we=Z(Ne,C);return`${Pe}/${we}`}const I=l.match(/^([A-G][b#]?)(.*)$/);if(!I)return l;let[,L,P]=I;X[L]&&(L=X[L]);let B=T.indexOf(L);if(B===-1)return l;let J=(B+C+12)%12;return T[J]+P}const V=(l=>{if(!l)return[];if(Array.isArray(l)&&l.length>0&&typeof l[0]=="string")return l;if(typeof l=="string")return l?l.split(`
`):[];if(Array.isArray(l)&&l.length>0&&Array.isArray(l[0])){const C=[];return l.forEach((I,L)=>{L>0&&C.push(""),I.forEach(P=>{if(P&&P.text){let B=P.text;P.chords&&P.chords.length>0&&(B=`[${P.chords[0]}]${B}`),C.push(B)}})}),C}return[]})(e.lyrics),Se=(e.chords||R(V)).map(l=>p!==0?Z(l,p):l),Ae=l=>{f(l),N(!1)},xe=l=>{if(W||O.size>0){i.warning("Please wait for current operation to complete before inserting a new line.");return}N(!0),f(l===-1?0:l+1)},de=async(l,C)=>{const I=[...V];if(x){E(!0);const L=o!==null&&o<=V.length?o:I.length;I.splice(L,0,l),w(I),k(P=>new Set([...P,L])),f(null),N(!1),n({...e,lyrics:I}).then(()=>{i.success("Line added successfully!"),w(null),E(!1),k(P=>{const B=new Set(P);return B.delete(L),B}),f(null),N(!1)}).catch(P=>{console.error("Failed to add line:",P),i.error("Failed to add new line. Please try again."),w(null),E(!1),k(B=>{const J=new Set(B);return J.delete(L),J}),N(!0),f(null)})}else E(!0),k(L=>new Set([...L,C])),I[C]=l,w(I),f(null),n({...e,lyrics:I}).then(()=>{i.success("Line updated successfully!"),w(null),E(!1),k(L=>{const P=new Set(L);return P.delete(C),P})}).catch(L=>{console.error("Failed to update line:",L),i.error("Failed to update line. Please try again."),w(null),E(!1),k(P=>{const B=new Set(P);return B.delete(C),B}),f(C)})},Y=()=>{f(null),N(!1)},pe=async l=>{if(W||O.has(l)){i.warning("Please wait for current operation to complete before deleting this line.");return}E(!0),G(I=>new Set([...I,l]));const C=[...V];C.splice(l,1),w(C);try{await n({...e,lyrics:C}),i.success("Line deleted successfully!"),w(null),E(!1),G(I=>{const L=new Set(I);return L.delete(l),L})}catch(I){console.error("Failed to delete line:",I),i.error("Failed to delete line. Please try again."),w(null),E(!1),G(L=>{const P=new Set(L);return P.delete(l),P})}},Te=async l=>{const{active:C,over:I}=l;if(C.id!==I.id){E(!0);const L=V.findIndex((J,ae)=>ae.toString()===C.id),P=V.findIndex((J,ae)=>ae.toString()===I.id),B=$t(V,L,P);w(B),$(P),n({...e,lyrics:B}).then(()=>{i.success("Lines reordered successfully!"),w(null),E(!1),$(null)}).catch(J=>{console.error("Failed to reorder lines:",J),i.error("Failed to reorder lines. Please try again."),w(null),E(!1),$(null)})}},Ie=()=>{F(V.join(`
`)),A(!0)},h=async()=>{te(!0);try{const l=g.split(`
`).filter(C=>C.trim()!=="");await n({...e,lyrics:l,chords:R(l)}),A(!1),i.success("Song lyrics saved successfully!")}catch(l){console.error("Failed to save whole song:",l),i.error("Failed to save song. Please try again.")}finally{te(!1)}},m=l=>{if(!l)return!1;const C=l.message||l||"";return["User not signed in to Google Drive","Expected OAuth 2 access token","login cookie or other valid authentication credential","Invalid Credentials","Authentication failed","unauthorized_client","invalid_token","expired_token","access_denied","token_expired","Request had invalid authentication credentials"].some(L=>C.toLowerCase().includes(L.toLowerCase()))},S=()=>{Q()},Q=async()=>{try{await q(nt({artistName:r.name,albumTitle:e.album?.title,songTitle:e.title,isGoogleDriveConnected:c})).unwrap(),i.success("Song deleted successfully!"),q(vt())}catch(l){console.error("Failed to delete song:",l),m(l)?(q(he(!1)),q(me(null)),i.error("Your Google Drive session has expired. Please sign in again to delete songs.")):i.error(l.message||"Failed to delete song. Please try again.")}},H=()=>{A(!1),F("")},ue=l=>{const C=/\[(.*?)\]/g,I=[];let L=l,P;for(;(P=C.exec(l))!==null;)I.push({chord:P[1],position:P.index,length:P[0].length});L=L.replace(/\[(.*?)\]/g,"");const B=I.map((J,ae)=>{let Ne=0;for(let we=0;we<ae;we++)Ne+=I[we].length;const Pe=p!==0?Z(J.chord,p):J.chord;return{...J,chord:Pe,position:J.position-Ne}});return t.jsxs("div",{className:"lyric-line-with-chords",children:[t.jsx("div",{className:"chord-labels",children:B.map((J,ae)=>t.jsx("span",{className:"chord-label",style:{left:`${J.position}ch`},onClick:()=>s(J.chord),children:J.chord},`chord-${ae}`))}),t.jsx("div",{className:"lyric-text-only",children:L})]})};_e.useEffect(()=>{y(be)},[e.title]);const re=()=>{y(l=>l+1),q(bt(e.title))},le=()=>{y(l=>l-1),q(yt(e.title))},ce=async()=>{D(!0);try{const l=V.map(I=>{const L=/\[([^\]]+)\]/g;return I.replace(L,(P,B)=>`[${Z(B,p)}]`)}),C={...e,lyrics:l,chords:R(l),chordFingerings:ve};await n(C),y(0),i.success("Transposed lyrics saved successfully!")}catch(l){console.error("Failed to save transposed lyrics:",l),i.error("Failed to save transposed lyrics. Please try again.")}finally{D(!1)}};return t.jsxs("div",{className:"song-detail",children:[t.jsxs("div",{className:"chords-section",children:[t.jsxs("div",{className:"chords-header",children:[t.jsxs("div",{className:"chords-header-left",children:[t.jsx("button",{className:"transpose-btn",title:"Transpose Down",onClick:le,children:"-"}),t.jsxs("span",{className:"transpose-label",children:["Transpose: ",p>0?`+${p}`:p," semitones"]}),t.jsx("button",{className:"transpose-btn",title:"Transpose Up",onClick:re,children:"+"}),t.jsxs("button",{className:"save-transpose-btn",onClick:ce,disabled:p===0||U,children:[U&&t.jsx(je,{size:"small"}),"Save Transposed Lyrics"]})]}),t.jsxs("div",{className:"instrument-selector",children:[t.jsx("label",{htmlFor:"instrument-select",className:"instrument-label",children:"Instrument:"}),t.jsxs("select",{id:"instrument-select",value:ee,onChange:l=>q(gt(l.target.value)),className:"instrument-select",children:[t.jsx("option",{value:"ukulele",children:"Ukulele"}),t.jsx("option",{value:"guitar",children:"Guitar"}),t.jsx("option",{value:"piano",children:"Piano"}),t.jsx("option",{value:"bassGuitar",children:"Bass Guitar"}),t.jsx("option",{value:"bassUkulele",children:"Bass Ukulele"}),t.jsx("option",{value:"baritoneUkulele",children:"Baritone Ukulele"})]})]})]}),t.jsx("div",{className:"chord-container",children:Se.map(l=>t.jsx("div",{className:"chord-item",onClick:()=>s(l),children:t.jsx(pt,{chord:l,instrument:ee})},l))})]}),t.jsx("div",{className:"lyrics-section",children:t.jsxs("div",{className:"lyrics-container",children:[t.jsxs("div",{className:"song-header-row",children:[t.jsx("div",{className:"song-header-main",children:t.jsxs("div",{className:"song-header-titles",children:[t.jsx("h3",{className:"song-header-title",children:e.title}),t.jsx("i",{className:"song-header-artist",children:r.name}),e.album&&e.album.title&&t.jsxs("span",{className:"song-header-meta",children:["â€¢ ",e.album.title]})]})}),t.jsxs("div",{className:"song-header-actions",children:[a&&!v&&t.jsxs(t.Fragment,{children:[t.jsxs("button",{className:"edit-whole-song-btn",onClick:Ie,children:[t.jsx(Pt,{})," Edit Whole Song"]}),t.jsxs("button",{className:"delete-song-btn",onClick:()=>{rt.confirm({title:"Delete song?",content:`Are you sure you want to delete "${e.title}" by ${r?.name||"Unknown Artist"}?`,okText:"Delete",cancelText:"Cancel",onOk:()=>S()})},children:[t.jsx(at,{})," Delete Song"]})]}),v&&t.jsxs("div",{className:"save-cancel-row",children:[t.jsxs("button",{className:"save-whole-song-btn",onClick:h,disabled:z,children:[z?t.jsx(je,{size:"small"}):t.jsx(Dt,{}),"Save"]}),t.jsx("button",{className:"cancel-whole-song-btn",onClick:H,children:"Cancel"})]})]})]}),v?t.jsx("textarea",{value:g,onChange:l=>F(l.target.value),className:"whole-song-textarea"}):t.jsx(Ft,{sensors:b,collisionDetection:Rt,onDragEnd:Te,children:t.jsxs(Ot,{items:(_||V).map((l,C)=>C.toString()),strategy:_t,children:[(_||V).map((l,C)=>t.jsx(us,{id:C.toString(),index:C,line:l,editingLineIndex:o,editingEnabled:a,hoveredLineIndex:j,setHoveredLineIndex:d,handleEditLine:Ae,handleInsertAfter:xe,handleDeleteLine:pe,handleSaveLine:de,handleCancelEdit:Y,renderLyricLine:ue,isThisLinePending:K===C,isDragDisabled:W||O.size>0,isPendingDelete:O.has(C),isAddingLine:x&&o===C,isPendingSave:M.has(C)},C)),x&&o===(_||V).length&&t.jsx(lt,{line:"",onSave:l=>de(l,(_||V).length),onCancel:Y,isAdding:!0})]})}),a&&!v&&t.jsx("div",{className:"add-line-row",children:t.jsxs("button",{className:"add-line-btn",onClick:()=>xe((_||V).length-1),disabled:W||O.size>0,children:[t.jsx(it,{})," Add Line"]})})]})})]})};class ms{apiEndpoint;albumCache;cacheExpiry;constructor(){this.apiEndpoint="https://songs-spotify-api.ai-recipe-notepad.workers.dev/api/spotify-search",this.albumCache=new Map,this.cacheExpiry=1440*60*1e3}async searchAlbumArt(s,n=null){try{const r=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({artist:s,album:n,searchType:"album"})});if(!r.ok)throw new Error(`Album search request failed: ${r.status}`);const a=await r.json();if(a.albums?.items?.length>0){const i=a.albums.items[0];return{albumArt:i.images?.[0]?.url||null,albumName:i.name,artistName:i.artists?.[0]?.name,releaseDate:i.release_date,spotifyUrl:i.external_urls?.spotify,totalTracks:i.total_tracks}}else if(a.tracks?.items?.length>0){const i=a.tracks.items[0];return{albumArt:i.album.images?.[0]?.url||null,albumName:i.album.name,artistName:i.artists?.[0]?.name,trackName:i.name,releaseDate:i.album.release_date,spotifyUrl:i.external_urls?.spotify}}return null}catch(r){return console.error("Spotify album search failed:",r),null}}async searchTrack(s,n,r=null){try{const a=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({artist:s,track:n,album:r})});if(!a.ok)throw new Error(`Search request failed: ${a.status}`);const i=await a.json();if(i.tracks?.items?.length>0){const o=i.tracks.items[0];return{albumArt:o.album.images?.[0]?.url||null,albumName:o.album.name,artistName:o.artists?.[0]?.name,trackName:o.name,releaseDate:o.album.release_date,spotifyUrl:o.external_urls?.spotify}}return null}catch(a){return console.error("Spotify search failed:",a),null}}async getAlbumsForArtist(s){if(!s||s.trim()==="")return[];const n=s.toLowerCase().trim(),r=this.albumCache.get(n);if(r&&Date.now()-r.timestamp<this.cacheExpiry)return r.albums;try{const a=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({artist:s,searchType:"artist-albums"})});if(!a.ok)throw a.status===404?console.warn("Spotify API endpoint not configured - album suggestions disabled"):console.error(`Artist albums search failed: ${a.status}`),new Error(`Artist albums search failed: ${a.status}`);const i=await a.json();if(i.error)throw console.warn("Spotify API error:",i.error),new Error(i.error);let o=[];return i.albums?.items&&(o=[...new Set(i.albums.items.map(f=>f.name))].sort()),this.albumCache.set(n,{albums:o,timestamp:Date.now()}),o}catch(a){return console.error("Failed to get artist albums:",a),this.albumCache.set(n,{albums:[],timestamp:Date.now()}),[]}}async searchArtists(s){if(!s||s.trim()==="")return[];const n=`artist_search_${s.toLowerCase().trim()}`,r=this.albumCache.get(n);if(r&&Date.now()-r.timestamp<this.cacheExpiry)return r.artists;try{const a=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({artist:s,searchType:"artist"})});if(!a.ok)throw console.error(`Artist search failed: ${a.status}`),new Error(`Artist search failed: ${a.status}`);const i=await a.json();if(i.error)throw console.warn("Spotify API error:",i.error),new Error(i.error);let o=[];return i.artists?.items&&(o=[...new Set(i.artists.items.map(f=>f.name))].sort()),this.albumCache.set(n,{artists:o,timestamp:Date.now()}),o}catch(a){return console.error("Failed to search artists:",a),this.albumCache.set(n,{artists:[],timestamp:Date.now()}),[]}}clearAlbumCache(){this.albumCache.clear()}getAlbumCacheStats(){return{size:this.albumCache.size,entries:Array.from(this.albumCache.keys())}}getAlbumArtUrl(s){return s?.albumArt?s.albumArt:null}async getTracksFromAlbum(s,n){if(!s||!n||s.trim()===""||n.trim()==="")return[];const r=`album_tracks_${s.toLowerCase().trim()}_${n.toLowerCase().trim()}`,a=this.albumCache.get(r);if(a&&Date.now()-a.timestamp<this.cacheExpiry)return a.tracks;try{const i=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({artist:s,album:n,searchType:"tracks"})});if(!i.ok)throw console.error(`Album tracks search failed: ${i.status}`),new Error(`Album tracks search failed: ${i.status}`);const o=await i.json();if(o.error)throw console.warn("Spotify API error:",o.error),new Error(o.error);let f=[];return o.tracks?.items&&(f=[...new Set(o.tracks.items.map(x=>x.name))].sort()),this.albumCache.set(r,{tracks:f,timestamp:Date.now()}),f}catch(i){return console.error("Failed to get album tracks:",i),this.albumCache.set(r,{tracks:[],timestamp:Date.now()}),[]}}async searchTracks(s,n=null){if(!s||s.trim()==="")return[];const r=`track_search_${s.toLowerCase().trim()}_${n?n.toLowerCase().trim():"any"}`,a=this.albumCache.get(r);if(a&&Date.now()-a.timestamp<this.cacheExpiry)return a.tracks;try{const i=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({track:s,artist:n,searchType:"track-search"})});if(!i.ok)throw console.error(`Track search failed: ${i.status}`),new Error(`Track search failed: ${i.status}`);const o=await i.json();if(o.error)throw console.warn("Spotify API error:",o.error),new Error(o.error);let f=[];return o.tracks?.items&&(f=[...new Set(o.tracks.items.map(x=>x.name))].sort()),this.albumCache.set(r,{tracks:f,timestamp:Date.now()}),f}catch(i){return console.error("Failed to search tracks:",i),this.albumCache.set(r,{tracks:[],timestamp:Date.now()}),[]}}}const ke=new ms,fs="albumArt_",gs=24,ps=(e,s)=>`${fs}${e}_${s||"unknown"}`.replace(/[^a-zA-Z0-9_]/g,"_"),ys=e=>{try{const s=localStorage.getItem(e);if(s){const{data:n,timestamp:r}=JSON.parse(s),a=Date.now(),i=r+gs*60*60*1e3;if(a<i)return n;localStorage.removeItem(e)}}catch(s){console.warn("Cache read error:",s)}return null},bs=(e,s)=>{try{const n={data:s,timestamp:Date.now()};localStorage.setItem(e,JSON.stringify(n))}catch(n){console.warn("Cache write error:",n)}},vs=({artist:e,album:s,size:n=150})=>{const[r,a]=u.useState(null),[i,o]=u.useState(!1),[f,x]=u.useState(null);return u.useEffect(()=>{(async()=>{if(!e)return;const j=ps(e,s),d=ys(j);if(d){console.log("ðŸŽ¯ Cache hit for:",e,s?`- ${s}`:"(any album)"),a(d);return}o(!0),x(null);try{console.log("ðŸŒ API call for:",e,s?`- ${s}`:"(searching artist albums)");const p=await ke.searchAlbumArt(e,s);a(p),p&&bs(j,p)}catch(p){let y="Failed to load album art";p.name==="TypeError"&&p.message.includes("Failed to fetch")?y="Network error: Cannot reach Spotify API service":p.message.includes("JSON")?y=`JSON Parse Error: ${p.message}`:p.message.includes("404")?y="API endpoint not found (404)":p.message.includes("401")?y="Authentication failed (401) - Check Spotify credentials":p.message.includes("403")?y="Access forbidden (403) - API quota exceeded?":p.message.includes("500")?y="Server error (500) - Spotify API or Worker issue":p.message&&(y=`Error: ${p.message}`),x(y),console.error("Album art fetch error details:",{name:p.name,message:p.message,stack:p.stack,artist:e,album:s})}finally{o(!1)}})()},[e,s]),i?t.jsx("div",{className:"album-art-placeholder",style:{width:n,height:n},children:t.jsx("div",{className:"album-art-loading-text",children:"Loading..."})}):f||!r?.albumArt?t.jsxs("div",{className:"album-art-placeholder album-art-missing",style:{width:n,height:n},children:[t.jsx("div",{className:"album-art-icon",children:"â™ª"}),t.jsx("div",{className:"album-art-text",children:"No album art found"})]}):t.jsx("div",{className:"album-art-wrapper",style:{width:n,height:n},children:t.jsx("img",{src:r.albumArt,alt:`${r.albumName} album art`,className:"album-art-image",style:{width:n,height:n},onError:N=>{N.target.style.display="none",x("Image failed to load")}})})};function Ss(e){const n=e.replace(/\[.*?\]/g,"").split(`
`),r=[];let a=0;for(;a<n.length;){let i=n[a].trim();if(/^\[.*?(?::.+)?\]$/.test(i)){(r.length===0||r[r.length-1]!=="")&&r.push(""),a++;continue}if(!i){(r.length===0||r[r.length-1]!=="")&&r.push(""),a++;continue}i=i.replace(/N\.C\./g,"    ");const o=/[A-G][#b]?(?:maj|min|m|sus|aug|dim|add)?[0-9]*(?:\([^)]+\))?(?:sus[0-9]*)?(?:[#b][0-9]+)*(?:\/[A-G][#b]?)?/g,f=i.match(o)||[],x=i.replace(o,"").trim();if(f.length>0&&(x===""||/^\s*$/.test(x))){const j=[];let d;const y=i.replace(/\s+/g," ").trim().match(/^[A-G][#b]?(?:maj|min|m|sus|aug|dim|add)?[0-9]*(?:\([^)]+\))?(?:sus[0-9]*)?(?:[#b][0-9]+)*(?:\/[A-G][#b]?)?$/);if(y){let g=a+1;for(;g<n.length&&!n[g].trim();)g++;if(g<n.length){const F=n[g].trim(),M=F.match(o)||[],k=F.replace(o,"").trim(),_=M.length>0&&(k===""||/^\s*$/.test(k)),w=/^\[.*?(?::.+)?\]$/.test(F);if(!_&&!w){r.push(`[${y[0]}]${F}`),a=g+1;continue}}r.push(`[${y[0]}]`),a++;continue}const v=/[A-G][#b]?(?:maj|min|m|sus|aug|dim|add)?[0-9]*(?:\([^)]+\))?(?:sus[0-9]*)?(?:[#b][0-9]+)*(?:\/[A-G][#b]?)?/g;for(;(d=v.exec(i))!==null;)j.push({chord:d[0],position:d.index});let A=a+1;for(;A<n.length&&!n[A].trim();)A++;if(A<n.length){const g=n[A].trim(),F=g.match(o)||[],M=g.replace(o,"").trim(),k=F.length>0&&(M===""||/^\s*$/.test(M)),_=/^\[.*?(?::.+)?\]$/.test(g);if(!k&&!_){const w=g,K=w.split(""),$=[];j.forEach(({chord:U,position:D})=>{let z=Math.min(D,w.length);if(z>=w.length)z=w.length;else for(;z<w.length&&z>0&&/\S/.test(w[z-1])&&/\S/.test(w[z]);)z++;$.push({pos:z,text:`[${U}]`})}),$.sort((U,D)=>D.pos-U.pos);const O=w.length,G=[],W=[];$.forEach(({pos:U,text:D})=>{U>=O?G.push({pos:U,text:D}):W.push({pos:U,text:D})}),W.forEach(({pos:U,text:D})=>{K.splice(U,0,D)});let E=K.join("");if(G.length>0){const U=G.sort((D,z)=>{const te=j.find(ee=>ee.chord===D.text.slice(1,-1))?.position||0,q=j.find(ee=>ee.chord===z.text.slice(1,-1))?.position||0;return te-q});for(let D=0;D<U.length;D++){const z=U[D].text,te=z.slice(1,-1);if(E+=z,D<U.length-1){const q=te.length+1;E+=" ".repeat(q)}}}r.push(E),a=A+1}else{let w="";j.forEach(({chord:K},$)=>{if(w+=`[${K}]`,$<j.length-1){const O=K.length+1;w+=" ".repeat(O)}}),r.push(w),a++}}else{let g="";j.forEach(({chord:F},M)=>{if(g+=`[${F}]`,M<j.length-1){const k=F.length+1;g+=" ".repeat(k)}}),r.push(g),a++}}else r.push(i),a++}for(;r[0]==="";)r.shift();for(;r[r.length-1]==="";)r.pop();return r.join(`
`)}const De="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20100%20100'%20width='100'%20height='100'%3e%3ccircle%20cx='50'%20cy='50'%20r='50'%20fill='%231DB954'/%3e%3cpath%20d='M75.5%2041.5c-12.5-7.5-33-8-45-4.5-1.5%200.5-3-0.5-3.5-2s0.5-3%202-3.5c13.5-4%2035.5-3%2049.5%205%201.5%200.5%201.5%202.5%201%204s-2.5%201.5-4%201z'%20fill='%23000'/%3e%3cpath%20d='M72.5%2051c-10.5-6.5-28-7-38-4-1.5%200.5-2.5-0.5-3-1.5s0.5-2.5%201.5-3c11.5-3.5%2031-3%2043%204.5%201%200.5%201.5%202%201%203s-2%201.5-3%201c-0.5%200-1-0.5-1.5-0z'%20fill='%23000'/%3e%3cpath%20d='M69.5%2060c-9-5.5-24-6-32-3.5-1%200.5-2-0.5-2.5-1.5s0.5-2%201.5-2.5c9.5-3%2026-2.5%2036%204%201%200.5%201%201.5%200.5%202.5s-1.5%201-2.5%201c-0.5%200-0.5%200-1%200z'%20fill='%23000'/%3e%3c/svg%3e",{Option:ye}=Ee,Ze=({song:e,artist:s,album:n,onSave:r,onCancel:a,isGoogleDriveConnected:i,isNewSong:o=!1,library:f=null,lyricsRef:x})=>{const[N,j]=u.useState(()=>e?.title||""),[d,p]=u.useState(()=>s?.name||""),[y,v]=u.useState(()=>n?.title||""),[A,g]=u.useState([]),[F,M]=u.useState(!1),[k,_]=u.useState([]),[w,K]=u.useState(!1),[$,O]=u.useState([]),[G,W]=u.useState(!1),[E,U]=u.useState(()=>typeof e?.lyrics=="string"?e.lyrics:""),[D,z]=u.useState([]),[te,q]=u.useState(!1),ee=u.useRef(null),be=u.useRef(null),ve=x??be,[c,b]=u.useState(""),[R,T]=u.useState(!1);u.useEffect(()=>{if(d&&d.trim()!==""){const m=setTimeout(async()=>{M(!0);try{const S=await ke.getAlbumsForArtist(d);g(S)}catch(S){console.log("Spotify album suggestions unavailable:",S.message),g([])}finally{M(!1)}},500);return()=>clearTimeout(m)}else g([]),M(!1)},[d]),u.useEffect(()=>{if(d&&d.trim()!==""&&d.length>0){const m=setTimeout(async()=>{K(!0);try{const S=await ke.searchArtists(d);_(S)}catch(S){console.log("Spotify artist suggestions unavailable:",S.message),_([])}finally{K(!1)}},300);return()=>clearTimeout(m)}else _([]),K(!1)},[d]),u.useEffect(()=>{if(d&&y&&d.trim()!==""&&y.trim()!==""){const m=setTimeout(async()=>{W(!0);try{const S=await ke.getTracksFromAlbum(d,y);O(S)}catch(S){console.log("Spotify track suggestions unavailable:",S.message),O([])}finally{W(!1)}},300);return()=>clearTimeout(m)}else O([]),W(!1)},[d,y]);const X=u.useMemo(()=>{if(!y||y.trim()==="")return A;const h=y.toLowerCase().trim();return A.filter(m=>m.toLowerCase().includes(h))},[A,y]),Z=u.useMemo(()=>{if(!d||d.trim()==="")return k;const h=d.toLowerCase().trim();return k.filter(m=>m.toLowerCase().includes(h))},[k,d]),ge=u.useMemo(()=>{if(!f?.artists)return[];let h=f.artists.map(m=>m.name).sort();if(d&&d.trim()!==""){const m=d.toLowerCase().trim();h=h.filter(S=>S.toLowerCase().includes(m))}return h},[f,d]),V=u.useMemo(()=>{if(!f?.artists||!d)return[];const h=f.artists.find(S=>S.name===d);if(!h?.albums)return[];let m=h.albums.map(S=>S.title).sort();if(y&&y.trim()!==""){const S=y.toLowerCase().trim();m=m.filter(Q=>Q.toLowerCase().includes(S))}return m},[f,d,y]),Se=u.useMemo(()=>{if(!f?.artists||!d||!y)return[];const h=f.artists.find(S=>S.name===d);if(!h?.albums)return[];const m=h.albums.find(S=>S.title===y);return m?.songs?m.songs.map(S=>S.title.toLowerCase().trim()):[]},[f,d,y]),Ae=u.useMemo(()=>{if(!$||$.length===0)return[];let h=$.filter(m=>!Se.includes(m.toLowerCase().trim()));if(N&&N.trim()!==""){const m=N.toLowerCase().trim();h=h.filter(S=>S.toLowerCase().includes(m))}return h},[$,Se,N]),xe=u.useMemo(()=>{if(!f?.artists||!d||!y)return[];const h=f.artists.find(Q=>Q.name===d);if(!h?.albums)return[];const m=h.albums.find(Q=>Q.title===y);if(!m?.songs)return[];let S=m.songs.map(Q=>Q.title).sort();if(N&&N.trim()!==""){const Q=N.toLowerCase().trim();S=S.filter(H=>H.toLowerCase().includes(Q))}return S},[f,d,y,N]),de=()=>{if(c.trim()){const m=Ss(c).split(`
`).filter(S=>S.trim()!=="").join(`
`);U(m),b(""),T(!1),ie.success("Lyrics converted successfully!")}};u.useEffect(()=>{const h=/\[([^\]]+)\]/g,m=[];let S;const Q=typeof E=="string"?E:"";for(;(S=h.exec(Q))!==null;){const H=S[1];m.includes(H)||m.push(H)}if(z(m.sort()),ee.current){const H=ee.current;H.style.height="auto",H.style.height=Math.max(400,H.scrollHeight)+"px"}},[E]),u.useEffect(()=>{const h=m=>{if(m.ctrlKey&&!m.shiftKey&&!m.altKey){const S=parseInt(m.key);if(S>=1&&S<=9){const Q=S-1;Q<D.length&&(m.preventDefault(),pe(D[Q]))}else if(m.key==="0"&&D.length>=10)m.preventDefault(),pe(D[9]);else{const H=["q","w","e","r","t","y","u","i","o","p"].indexOf(m.key.toLowerCase());H!==-1&&D.length>10+H&&(m.preventDefault(),pe(D[10+H]))}}};return document.addEventListener("keydown",h),()=>{document.removeEventListener("keydown",h)}},[D]);const Y=()=>{const h=typeof E=="string"?E:"";if(!h)return t.jsx("div",{className:"preview-empty",children:"No lyrics to preview"});const m=h.split(`
`);return t.jsx("div",{className:"lyrics-preview",children:m.map((S,Q)=>{if(!S.trim())return t.jsx("div",{className:"preview-line empty-line",children:"Â "},Q);const H=/\[(.*?)\]/g,ue=[];let re=S,le;for(;(le=H.exec(S))!==null;)ue.push({chord:le[1],position:le.index,length:le[0].length});re=re.replace(/\[(.*?)\]/g,"");const ce=ue.map((l,C)=>{let I=0;for(let L=0;L<C;L++)I+=ue[L].length;return{...l,position:l.position-I}});return t.jsxs("div",{className:"lyric-line-with-chords",children:[t.jsx("div",{className:"chord-labels",children:ce.map((l,C)=>t.jsx("span",{className:"chord-label",style:{left:`${l.position}ch`},children:l.chord},`chord-${C}`))}),t.jsx("div",{className:"lyric-text-only",children:re})]},Q)})})},pe=async h=>{const m=ee.current;if(!m)return;const S=m.selectionStart,Q=m.selectionEnd,H=E.slice(0,S),ue=E.slice(Q),re=`[${h}]`,le=H+re+ue;U(le);try{await navigator.clipboard.writeText(re),ie.success(`${re} copied to clipboard`)}catch(ce){console.error("Failed to copy to clipboard:",ce),ie.info(`${re} inserted`)}setTimeout(()=>{m.focus();const ce=S+re.length;m.setSelectionRange(ce,ce)},0)},Te=async()=>{if(o){if(!N.trim()){ie.error("Please enter a song title");return}if(!d.trim()){ie.error("Please enter an artist name");return}if(!y.trim()){ie.error("Please enter an album title");return}}if(!i&&!o){ie.error("Please sign in to Google Drive to save changes");return}q(!0);try{if(o)await r({title:N.trim(),artist:d.trim(),album:y.trim(),lyrics:E});else{const h={...e,title:N.trim(),lyrics:E,updatedAt:new Date().toISOString()};await r(h,{artist:d.trim(),album:y.trim()})}ie.success(o?"Song created successfully!":"Song saved successfully!")}catch(h){console.error("Failed to save song:",h),ie.error(`Failed to ${o?"create":"save"} song. Please try again.`)}finally{q(!1)}},Ie=()=>{(o?N.trim()!==""||d.trim()!==""||y.trim()!==""||E.trim()!=="":E!==(e?.lyrics||""))?rt.confirm({title:"Unsaved changes",content:"You have unsaved changes. Are you sure you want to cancel?",okText:"Yes",cancelText:"No",onOk:()=>a()}):a()};return t.jsxs("div",{className:"song-editor",children:[t.jsx("div",{className:"song-editor-header",children:t.jsx("div",{className:"song-info",children:t.jsxs("div",{className:"song-form",children:[t.jsx("div",{className:"form-row",children:t.jsxs("div",{className:"form-group",children:[t.jsx("label",{children:"Artist"}),t.jsxs(Ee,{value:d,onChange:p,placeholder:"Type to search for artists",size:"large",showSearch:!0,allowClear:!0,loading:w,className:"full-width-select",filterOption:!1,onSearch:p,notFoundContent:w?"Searching...":"No artists found",children:[ge.map((h,m)=>t.jsxs(ye,{value:h,children:["ðŸ“š ",h]},`library-artist-${m}-${h}`)),Z.map((h,m)=>t.jsxs(ye,{value:h,children:[t.jsx("img",{src:De,alt:"Spotify",className:"spotify-icon"}),h]},`spotify-artist-${m}-${h}`))]})]})}),t.jsx("div",{className:"form-row",children:t.jsxs("div",{className:"form-group",children:[t.jsx("label",{children:"Album"}),t.jsxs(Ee,{value:y,onChange:v,placeholder:"Type to search for albums",size:"large",showSearch:!0,allowClear:!0,loading:F,className:"full-width-select",filterOption:!1,onSearch:v,notFoundContent:F?"Loading albums...":"No albums found",children:[V.map((h,m)=>t.jsxs(ye,{value:h,children:["ðŸ“š ",h]},`library-album-${m}-${h}`)),X.map((h,m)=>t.jsxs(ye,{value:h,children:[t.jsx("img",{src:De,alt:"Spotify",className:"spotify-icon"}),h]},`spotify-album-${m}-${h}`))]})]})}),t.jsx("div",{className:"form-row",children:t.jsxs("div",{className:"form-group",children:[t.jsx("label",{children:"Title"}),t.jsxs(Ee,{value:N,onChange:j,placeholder:"Type to search for songs",size:"large",showSearch:!0,allowClear:!0,loading:G,className:"full-width-select",filterOption:!1,onSearch:j,notFoundContent:G?"Loading tracks...":"No tracks found",children:[xe.map((h,m)=>t.jsxs(ye,{value:h,children:["ðŸ“š ",h]},`library-${m}-${h}`)),Ae.map((h,m)=>t.jsxs(ye,{value:h,children:[t.jsx("img",{src:De,alt:"Spotify",className:"spotify-icon"}),h]},`spotify-${m}-${h}`))]})]})})]})})}),t.jsxs("div",{className:"editor-main",children:[t.jsxs("div",{className:"editor-pane",ref:ve,children:[t.jsxs("div",{className:"editor-header",children:[t.jsxs("h3",{children:["Edit Lyrics ",t.jsx("small",{children:"(use [chord] format)"})]}),t.jsxs("div",{className:"ug-conversion-compact",children:[t.jsx(oe,{type:"default",onClick:()=>T(!R),size:"small",className:"ug-toggle-btn",children:R?"â–¼ Hide UG Converter":"â–¶ Convert from Ultimate Guitar"}),R&&t.jsxs("div",{className:"conversion-content",children:[t.jsx("textarea",{value:c,onChange:h=>b(h.target.value),placeholder:"Paste Ultimate Guitar format lyrics here...",className:"conversion-textarea-compact",rows:4,spellCheck:!1}),t.jsxs("div",{className:"conversion-actions",children:[t.jsx(oe,{type:"primary",onClick:de,disabled:!c.trim(),size:"small",children:"Convert to Inline Format"}),t.jsx(oe,{type:"text",onClick:()=>{b(""),T(!1)},size:"small",children:"Cancel"})]})]})]})]}),D.length>0&&t.jsxs("div",{className:"chord-palette-ribbon",children:[t.jsx("h4",{children:"Chord Palette (click to insert or use Ctrl+1-9, Ctrl+0):"}),t.jsx("div",{className:"chord-buttons",children:D.map((h,m)=>t.jsxs("button",{className:"chord-button",onClick:()=>pe(h),title:`Insert [${h}] at cursor position and copy to clipboard. Shortcut: Ctrl+${m<9?m+1:0}`,children:[t.jsx("span",{className:"chord-text",children:h}),m<10&&t.jsxs("span",{className:"chord-shortcut",children:["Ctrl+",m<9?m+1:0]})]},m))})]}),t.jsx("textarea",{ref:ee,value:E,onChange:h=>U(h.target.value),placeholder:"Enter lyrics with chords in [chord] format...",className:`lyrics-editor${D.length>0?" has-chord-palette":""}`,spellCheck:!1}),t.jsx("div",{className:"editor-help",children:t.jsxs("p",{children:[t.jsx("strong",{children:"Tip:"})," Use square braces around chords: [C], [C#], [Cm] [Csus4], etc.",t.jsx("br",{}),"Click palette buttons or use ",t.jsx("strong",{children:"Ctrl+1-9, Ctrl+0"})," to insert chords at cursor."]})})]}),t.jsxs("div",{className:`preview-pane${D.length>0?" has-chord-ribbon":""}`,children:[t.jsx("h3",{children:"Preview"}),Y()]})]}),t.jsxs("div",{className:"editor-actions-bottom",children:[t.jsx(oe,{type:"primary",icon:t.jsx(zt,{}),onClick:Te,loading:te,disabled:!i&&!o,size:"large",children:o?"Create Song":"Save Changes"}),t.jsx(oe,{icon:t.jsx(Bt,{}),onClick:Ie,className:"cancel-btn",size:"large",children:"Cancel"})]})]})};function xs({library:e,onSelectSong:s}){const[n,r]=u.useState(""),[a,i]=u.useState(new Set),[o,f]=u.useState(new Set),[x,N]=u.useState(null),j=u.useMemo(()=>{if(!e?.artists)return{artists:[]};const v=n.toLowerCase().trim();return v?{artists:e.artists.map(g=>{const F=g.name?.toLowerCase().includes(v),M=(g.albums||[]).map(k=>{const _=k.title?.toLowerCase().includes(v),w=(k.songs||[]).filter(K=>K.title?.toLowerCase().includes(v));return _||w.length>0?{...k,songs:_?k.songs:w}:null}).filter(Boolean);return F||M.length>0?{...g,albums:F?g.albums:M}:null}).filter(Boolean)}:e},[e,n]),d=u.useCallback(v=>{i(A=>{const g=new Set(A);return g.has(v)?g.delete(v):g.add(v),g})},[]),p=u.useCallback(v=>{f(A=>{const g=new Set(A);return g.has(v)?g.delete(v):g.add(v),g})},[]),y=u.useCallback((v,A,g)=>{const F=`${A}-${g}-${v.title}`;N(F),s&&s(v,A,g)},[s]);return t.jsxs(Wt,{sx:{width:"100%"},children:[t.jsx(Kt,{fullWidth:!0,variant:"outlined",size:"small",value:n,onChange:v=>r(v.target.value),placeholder:"Filter by song, artist, or album...",sx:{mb:2}}),t.jsx("div",{className:"song-tree",children:j.artists.length===0?t.jsx("div",{className:"song-tree-empty",children:n?"No songs found matching your search.":"No songs available."}):j.artists.map(v=>{const A=a.has(v.name);return t.jsxs("div",{className:"tree-artist",children:[t.jsxs("div",{className:"tree-node tree-artist-node",onClick:()=>d(v.name),children:[t.jsx("span",{className:"tree-toggle",children:v.albums?.length>0?A?"â–¼":"â–¶":"â€¢"}),t.jsx("span",{className:"tree-artist-name",children:v.name}),t.jsxs("span",{className:"tree-count",children:["(",v.albums?.length||0," albums)"]})]}),A&&t.jsx("div",{className:"tree-albums",style:{marginLeft:"20px"},children:(v.albums||[]).map(g=>{const F=`${v.name}-${g.title}`,M=o.has(F);return t.jsxs("div",{className:"tree-album",children:[t.jsxs("div",{className:"tree-node tree-album-node",onClick:()=>p(F),children:[t.jsx("span",{className:"tree-toggle",children:g.songs?.length>0?M?"â–¼":"â–¶":"â€¢"}),t.jsx("span",{className:"tree-album-title",children:g.title}),t.jsxs("span",{className:"tree-count",children:["(",g.songs?.length||0," songs)"]})]}),M&&t.jsx("div",{className:"tree-songs",children:(g.songs||[]).map(k=>{const _=`${v.name}-${g.title}-${k.title}`,w=x===_;return t.jsx("div",{className:`tree-node tree-song-node ${w?"selected":""}`,onClick:()=>y(k,v.name,g.title),children:t.jsxs("span",{className:"tree-song-text",children:["â™ª ",k.title]})},_)})})]},F)})})]},v.name)})})]})}function ws({library:e,selectedSong:s,editingEnabled:n,onSelectSong:r}){try{const a={libraryExists:!!e,hasArtists:!!e?.artists,artistCount:e?.artists?.length||0,totalSongs:e?.artists?e.artists.reduce((i,o)=>i+(o.albums||[]).reduce((f,x)=>f+(x.songs||[]).length,0),0):0,selectedSongExists:!!s,editingEnabled:n,libraryStructure:e?Object.keys(e):[]};console.log("ðŸŽµ SongListTest received props:",a),e?.artists&&e.artists.length>0?console.log("ðŸŽ¤ SongListTest first few artists:",e.artists.slice(0,3).map(i=>({name:i.name,albumCount:i.albums?.length||0,songCount:(i.albums||[]).reduce((o,f)=>o+(f.songs||[]).length,0)}))):console.log("âŒ SongListTest: No artists found in library")}catch(a){console.error("âŒ SongListTest: Error analyzing props:",a)}return t.jsx(xs,{library:e,selectedSong:s,editingEnabled:n,onSelectSong:r})}function Cs(){return ds({queryKey:["library","full"],queryFn:async()=>{console.log("ðŸš€ useLibraryQuery: Starting library fetch...");try{const e=await fe.loadLibrary();return console.log("ðŸ“š useLibraryQuery: Library loaded successfully:",{hasArtists:!!e?.artists,artistCount:e?.artists?.length||0,totalSongs:e?.artists?e.artists.reduce((s,n)=>s+(n.albums||[]).reduce((r,a)=>r+(a.songs||[]).length,0),0):0,libraryStructure:e?Object.keys(e):[]}),e}catch(e){throw console.error("âŒ useLibraryQuery: Failed to load library:",e),e}},staleTime:1e3*60,refetchOnWindowFocus:!1})}var et={};const js=()=>{const{message:e}=Me.useApp(),s=st(),n=se(c=>c.songs.library),r=se(c=>c.songs.selectedSong),a=se(c=>c.songs.isGoogleDriveConnected),i=se(c=>c.songs.userInfo),o=se(c=>c.songs.isLoading),f=se(c=>c.songs.error);se(c=>c.library?.entries||[]);const x=se(c=>c.library?.fullLibrary||null),{data:N,isLoading:j}=Cs(),d=N||x,[p,y]=u.useState(!1),[v,A]=u.useState(!1),[g,F]=u.useState(!1),M=u.useCallback(()=>!n||!n.artists?0:n.artists.reduce((c,b)=>c+b.albums.reduce((R,T)=>R+(T.songs?T.songs.length:0),0),0),[n]);u.useEffect(()=>{try{console.log("SongTabsApp observed songs store library change â€” artists=",n&&n.artists?n.artists.length:0)}catch{}},[n]);const k=u.useRef(null);u.useEffect(()=>{try{if(console.log("ðŸ”„ SongTabsApp fullLibrary effect triggered:",{fullLibraryPresent:!!d,fullLibraryHasArtists:!!d?.artists,fullLibraryArtistCount:d?.artists?.length||0,reduxLibraryHasArtists:!!n?.artists,reduxLibraryArtistCount:n?.artists?.length||0,fullLibraryStructure:d?Object.keys(d):[],reduxLibraryStructure:n?Object.keys(n):[]}),d&&d.artists&&Array.isArray(d.artists)){const c=JSON.stringify(d.artists);if(k.current===c){console.log("ðŸ“‹ Full library already applied to songs store (no-op)");return}const b=n?.artists?.length||0,R=d.artists.length;console.log("ðŸ”„ Overwriting Redux songs store from Drive library:",{existingArtists:b,newArtists:R,firstFewArtists:d.artists.slice(0,3).map(T=>({name:T.name,albumCount:T.albums?.length||0,totalSongs:(T.albums||[]).reduce((X,Z)=>X+(Z.songs||[]).length,0)}))}),s(St({artists:d.artists}));try{s(xt(d)),console.log("ðŸ“š Successfully set full library into library slice")}catch(T){console.warn("âš ï¸ Failed to set full library into library slice:",T)}k.current=c,console.log("âœ… Songs store successfully overwritten from fullLibrary (Drive)")}else d?console.log("âš ï¸ fullLibrary present but no artists array found:",{fullLibrary:d,hasArtists:!!d?.artists,artistsType:typeof d?.artists,isArray:Array.isArray(d?.artists)}):console.log("âŒ No fullLibrary data available yet")}catch(c){console.error("Error applying fullLibrary to songs store:",c)}},[d,n,s]);const _=u.useCallback(()=>{s(Be())},[s]),w=u.useCallback(async()=>{try{await s(We()).unwrap(),console.log("Library loaded from Google Drive")}catch(c){console.error("Failed to load library from Google Drive:",c);let b="Failed to load library from Google Drive";typeof c=="string"?c.includes("User not signed in")?b="Please sign in to Google Drive to access your music library":c.includes("JSON")?b="Invalid JSON format in Google Drive library file":c.includes("401")?b="Google Drive authentication expired - please sign in again":c.includes("403")?b="Access denied to Google Drive - check permissions":c.includes("404")?b="Library file not found in Google Drive - will create new one":c.includes("500")?b="Google Drive server error - try again later":c.includes("Network Error")||c.includes("Failed to fetch")?b="Network error - check your internet connection":b=`Google Drive error: ${c}`:c?.message&&(b=`Error: ${c.message}`),console.error("Detailed error info:",{errorType:typeof c,errorMessage:c?.message||c,errorStack:c?.stack,timestamp:new Date().toISOString()}),te(c)||b.includes("sign in")||b.includes("authentication")?(e.error(b),s(he(!1)),s(me(null))):e.error(b),s(Be())}},[s,e]),K=async c=>{if(r)try{const b=r.artist.name,R=r.album.title,T=r.title;await s(Je({artistName:b,albumTitle:R,songTitle:T,updatedSongData:c,isGoogleDriveConnected:a})).unwrap(),e.success("Song updated successfully")}catch(b){console.error("Failed to update song:",b),te(b)?(s(he(!1)),s(me(null)),e.error("Your Google Drive session has expired. Please sign in again to save changes.")):e.error("Failed to save song changes. Please try again.")}},$=async(c,b=null)=>{if(r)try{const R=b?.artist||r.artist.name,T=b?.album||r.album.title,X=c.title||r.title;await s(Je({artistName:r.artist.name,albumTitle:r.album.title,songTitle:r.title,updatedSongData:c,newArtistName:R,newAlbumTitle:T,newSongTitle:X,isGoogleDriveConnected:a})).unwrap(),e.success("Song updated successfully"),y(!1)}catch(R){console.error("Failed to update song:",R),te(R)?(s(he(!1)),s(me(null)),e.error("Your Google Drive session has expired. Please sign in again to save changes.")):e.error("Failed to save song changes. Please try again.")}};u.useEffect(()=>{(async()=>{try{const R=(X=>{try{const ge=new Function("k","try { return import.meta.env[k]; } catch(e) { return undefined; }")(X);if(ge)return ge}catch{}return globalThis.__IMPORT_META_ENV__&&globalThis.__IMPORT_META_ENV__[X]?globalThis.__IMPORT_META_ENV__[X]:et&&et[X]||void 0})("VITE_GOOGLE_CLIENT_ID");if(!R)throw new Error("Google Client ID not found in environment variables");await fe.initialize(R);const T=fe.getSignInStatus();T.isSignedIn?(s(he(!0)),s(me({email:T.userEmail,name:T.userName,picture:T.userPicture})),console.log("Restored user session for:",T.userEmail)):(console.debug("No valid session found, checking if library already loaded..."),!d||!d.artists||d.artists.length===0?(console.debug("No existing library data, using mock library"),_()):console.debug("Real library data already available, skipping mock library"))}catch(b){console.error("Failed to initialize Google Drive:",b),!d||!d.artists||d.artists.length===0?(console.debug("No existing library data, using mock library as fallback"),_()):console.debug("Real library data already available, skipping mock library fallback")}})()},[s,w,_]);const O=async c=>{try{await fe.handleOAuthToken(c);const b=fe.getSignInStatus();s(he(!0)),s(me({email:b.userEmail,name:b.userName,picture:b.userPicture})),await w()}catch(b){console.error("Google Sign-In failed:",b),e.error("Failed to connect to Google Drive. Please try again.")}},G=c=>{console.error("Google Sign-In error:",c),e.error("Failed to sign in with Google. Please try again.")},W=async()=>{try{await fe.signOut(),s(he(!1)),s(me(null)),_()}catch(c){console.error("Failed to sign out:",c)}},E=async c=>{try{fe.updateSettings(c),e.success("Google Drive settings updated successfully"),a&&await w()}catch(b){console.error("Failed to update settings:",b),e.error("Failed to update Google Drive settings")}},{setMenuItems:U}=wt();u.useEffect(()=>(U([]),()=>U([])),[U,s]);const D=_e.useRef(null),z=_e.useCallback((c,b,R)=>{if(c&&b&&R){const T={...c,title:c.title,artist:{name:b},album:{title:R}};s(Ke(T)),setTimeout(()=>{D.current?D.current.scrollIntoView({behavior:"smooth"}):window.scrollTo({top:0,behavior:"smooth"})},100),c.chordFingerings?s(He(c.chordFingerings)):s(He({}))}},[s]),te=c=>{if(!c)return!1;const b=c.message||c||"";return["User not signed in to Google Drive","Expected OAuth 2 access token","login cookie or other valid authentication credential","Invalid Credentials","Authentication failed","unauthorized_client","invalid_token","expired_token","access_denied","token_expired","Request had invalid authentication credentials"].some(T=>b.toLowerCase().includes(T.toLowerCase()))},q=c=>{s(jt(c))},ee=()=>{A(!0)},be=async c=>{try{const{title:b,artist:R,album:T,lyrics:X}=c,Z=n.artists?.find(Y=>Y.name===R);Z||await s(At({artistName:R,isGoogleDriveConnected:a})).unwrap(),(n.artists?.find(Y=>Y.name===R)||Z)?.albums?.find(Y=>Y.title===T)||await s(Nt({artistName:R,albumTitle:T,isGoogleDriveConnected:a})).unwrap(),await s(Lt({artistName:R,albumTitle:T,songData:{title:b,lyrics:X||"",notes:"",chords:""},isGoogleDriveConnected:a})).unwrap();const de=(await s(We()).unwrap()).artists?.find(Y=>Y.name===R)?.albums?.find(Y=>Y.title===T)?.songs?.find(Y=>Y.title===b);de&&z(de,R,T),A(!1),e.success("Song created successfully!")}catch(b){console.error("Failed to create song:",b),e.error("Failed to create song. Please try again.")}},ve=async()=>{try{await s(nt({artistName:r.artist?.name,albumTitle:r.album?.title,songTitle:r.title,isGoogleDriveConnected:a})).unwrap(),s(Ke(null)),e.success("Song deleted successfully!")}catch(c){console.error("Failed to delete song:",c),e.error("Failed to delete song. Please try again.")}};return t.jsxs("div",{className:"song-tabs-app",children:[t.jsxs("div",{className:`songs-content-vertical ${p||v?"mode-full":""}`,children:[r&&t.jsx("div",{className:"selected-song-section",children:p?t.jsx(Ze,{song:r,artist:r.artist,album:r.album,onSave:$,onCancel:()=>y(!1),isGoogleDriveConnected:a,lyricsRef:D}):t.jsxs("div",{className:"song-view-body",children:[t.jsxs("div",{className:"song-view-header",children:[t.jsx(vs,{artist:r.artist?.name,album:r.album?.title}),t.jsxs("div",{className:"song-view-header-main",children:[t.jsxs("div",{className:"song-title-row",children:[t.jsx("h2",{className:"song-title",children:r.title}),a&&t.jsxs(t.Fragment,{children:[t.jsx(oe,{type:"text",size:"small",onClick:()=>y(!0),className:"song-action-button edit",title:"Edit Song",children:"âœï¸"}),t.jsx(Ht,{title:"Delete Song",description:`Are you sure you want to delete "${r.title}"? This action cannot be undone.`,onConfirm:ve,okText:"Yes, Delete",cancelText:"Cancel",okType:"danger",children:t.jsx(oe,{type:"text",size:"small",className:"song-action-button delete",title:"Delete Song",children:"ðŸ—‘ï¸"})})]})]}),t.jsxs("p",{className:"song-subtitle",children:[r.artist?.name," - ",r.album?.title]})]}),t.jsx("div",{className:"song-action-column",children:t.jsx(oe,{onClick:()=>{const c=document.querySelector(".song-library-section");c&&c.scrollIntoView({behavior:"smooth"})},className:"scroll-library-button",children:"ðŸ“š Scroll to Song Library"})})]}),t.jsx("div",{className:"song-detail-wrapper",children:t.jsx(hs,{song:r,artist:r.artist,album:r.album,editingEnabled:!1,onUpdateSong:K,onPinChord:q})})]})}),v&&t.jsx("div",{className:"new-song-section",children:t.jsx(Ze,{song:{lyrics:""},artist:{name:""},album:{title:""},onSave:be,onCancel:()=>A(!1),isGoogleDriveConnected:a,isNewSong:!0,library:n})}),!p&&!v&&t.jsxs("div",{className:`song-library-section ${r?"has-selected-song":"no-selected-song"}`,children:[t.jsx(Jt,{appName:"Songs",isGoogleDriveConnected:a||g,userInfo:i,onSignIn:O,onSignOut:W,onSettingsChange:E,primaryAction:g||a?{label:"Add Song",onClick:ee,style:{backgroundColor:"#4CAF50",borderColor:"#4CAF50"}}:null,leftContent:t.jsxs("div",{className:"editing-toggle",children:[t.jsx("span",{children:"Editing"}),t.jsx(Vt,{checked:g,onChange:c=>F(c),"aria-label":"editing-toggle"})]}),libraryInfo:{title:"Songs",emoji:"ðŸŽµ",count:M(),isLoading:o},googleSignInProps:{onError:G,disabled:o},className:"songs-navigation"}),t.jsx(ws,{library:n,onSelectSong:z,selectedSong:r,editingEnabled:a})]}),!r&&!v&&t.jsx("div",{className:"empty-state",children:t.jsx("p",{children:"Select a song from your library above to see its chord chart and lyrics."})})]}),f&&t.jsxs("div",{className:"error-message",children:["Error: ",f,t.jsx(oe,{size:"small",onClick:()=>s(Ct()),className:"dismiss-error-button",children:"Dismiss"})]})]})},Es=()=>t.jsx(Me,{children:t.jsx(js,{})});export{Es as default};
//# sourceMappingURL=SongTabsAppModern-Bfd-Ge6T.js.map
