import{U as lt,V as Ue,W as re,X as Fe,Y as xe,Z as Re,$ as Oe,a0 as Qe,a1 as ct,a2 as Ne,a3 as ut,a4 as dt,a5 as ze,a6 as Ze,b as u,a7 as ht,a8 as et,j as t,x as Me,k as tt,f as ee,R as $e,S as we,a9 as mt,aa as ft,M as st,ab as gt,ac as pt,ad as rt,ae as yt,af as he,ag as me,ah as Le,B as oe,s as ie,ai as ye,aj as bt,ak as St,al as Be,am as vt,z as xt,an as We,ao as Ke,ap as wt,aq as He,ar as Ct,as as jt,at as At,au as Nt}from"./index-B9d-t28p.js";import{d as Lt,e as Je,s as kt,K as Et,h as Tt,b as It,c as nt,k as Pt,D as Dt,f as Ft,S as Rt,v as Ot,i as at,g as $t,u as _t,C as Mt,l as Gt,j as Ut,F as Qt,a as zt,B as Bt,T as Wt,P as Kt,A as Ht}from"./sortable.esm-CXcC7hEi.js";import"./index-D5aW1ZH9.js";var Jt=class extends lt{constructor(e,s){super(),this.options=s,this.#s=e,this.#n=null,this.#r=Ue(),this.bindMethods(),this.setOptions(s)}#s;#e=void 0;#f=void 0;#t=void 0;#i;#u;#r;#n;#g;#d;#h;#o;#l;#a;#m=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(this.#e.addObserver(this),qe(this.#e,this.options)?this.#c():this.updateResult(),this.#S())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return _e(this.#e,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return _e(this.#e,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#v(),this.#x(),this.#e.removeObserver(this)}setOptions(e){const s=this.options,n=this.#e;if(this.options=this.#s.defaultQueryOptions(e),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof re(this.options.enabled,this.#e)!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");this.#w(),this.#e.setOptions(this.options),s._defaulted&&!Fe(this.options,s)&&this.#s.getQueryCache().notify({type:"observerOptionsUpdated",query:this.#e,observer:this});const r=this.hasListeners();r&&Ve(this.#e,n,this.options,s)&&this.#c(),this.updateResult(),r&&(this.#e!==n||re(this.options.enabled,this.#e)!==re(s.enabled,this.#e)||xe(this.options.staleTime,this.#e)!==xe(s.staleTime,this.#e))&&this.#p();const a=this.#y();r&&(this.#e!==n||re(this.options.enabled,this.#e)!==re(s.enabled,this.#e)||a!==this.#a)&&this.#b(a)}getOptimisticResult(e){const s=this.#s.getQueryCache().build(this.#s,e),n=this.createResult(s,e);return Vt(this,n)&&(this.#t=n,this.#u=this.options,this.#i=this.#e.state),n}getCurrentResult(){return this.#t}trackResult(e,s){return new Proxy(e,{get:(n,r)=>(this.trackProp(r),s?.(r),r==="promise"&&!this.options.experimental_prefetchInRender&&this.#r.status==="pending"&&this.#r.reject(new Error("experimental_prefetchInRender feature flag is not enabled")),Reflect.get(n,r))})}trackProp(e){this.#m.add(e)}getCurrentQuery(){return this.#e}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){const s=this.#s.defaultQueryOptions(e),n=this.#s.getQueryCache().build(this.#s,s);return n.fetch().then(()=>this.createResult(n,s))}fetch(e){return this.#c({...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#t))}#c(e){this.#w();let s=this.#e.fetch(this.options,e);return e?.throwOnError||(s=s.catch(Re)),s}#p(){this.#v();const e=xe(this.options.staleTime,this.#e);if(Oe||this.#t.isStale||!Qe(e))return;const n=ct(this.#t.dataUpdatedAt,e)+1;this.#o=Ne.setTimeout(()=>{this.#t.isStale||this.updateResult()},n)}#y(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(this.#e):this.options.refetchInterval)??!1}#b(e){this.#x(),this.#a=e,!(Oe||re(this.options.enabled,this.#e)===!1||!Qe(this.#a)||this.#a===0)&&(this.#l=Ne.setInterval(()=>{(this.options.refetchIntervalInBackground||ut.isFocused())&&this.#c()},this.#a))}#S(){this.#p(),this.#b(this.#y())}#v(){this.#o&&(Ne.clearTimeout(this.#o),this.#o=void 0)}#x(){this.#l&&(Ne.clearInterval(this.#l),this.#l=void 0)}createResult(e,s){const n=this.#e,r=this.options,a=this.#t,i=this.#i,o=this.#u,x=e!==n?e.state:this.#f,{state:N}=e;let C={...N},d=!1,g;if(s._optimisticResults){const F=this.hasListeners(),G=!F&&qe(e,s),Q=F&&Ve(e,n,s,r);(G||Q)&&(C={...C,...dt(N.data,e.options)}),s._optimisticResults==="isRestoring"&&(C.fetchStatus="idle")}let{error:b,errorUpdatedAt:S,status:j}=C;g=C.data;let p=!1;if(s.placeholderData!==void 0&&g===void 0&&j==="pending"){let F;a?.isPlaceholderData&&s.placeholderData===o?.placeholderData?(F=a.data,p=!0):F=typeof s.placeholderData=="function"?s.placeholderData(this.#h?.state.data,this.#h):s.placeholderData,F!==void 0&&(j="success",g=ze(a?.data,F,s),d=!0)}if(s.select&&g!==void 0&&!p)if(a&&g===i?.data&&s.select===this.#g)g=this.#d;else try{this.#g=s.select,g=s.select(g),g=ze(a?.data,g,s),this.#d=g,this.#n=null}catch(F){this.#n=F}this.#n&&(b=this.#n,g=this.#d,S=Date.now(),j="error");const P=C.fetchStatus==="fetching",_=j==="pending",E=j==="error",M=_&&P,A=g!==void 0,R={status:j,fetchStatus:C.fetchStatus,isPending:_,isSuccess:j==="success",isError:E,isInitialLoading:M,isLoading:M,data:g,dataUpdatedAt:C.dataUpdatedAt,error:b,errorUpdatedAt:S,failureCount:C.fetchFailureCount,failureReason:C.fetchFailureReason,errorUpdateCount:C.errorUpdateCount,isFetched:C.dataUpdateCount>0||C.errorUpdateCount>0,isFetchedAfterMount:C.dataUpdateCount>x.dataUpdateCount||C.errorUpdateCount>x.errorUpdateCount,isFetching:P,isRefetching:P&&!_,isLoadingError:E&&!A,isPaused:C.fetchStatus==="paused",isPlaceholderData:d,isRefetchError:E&&A,isStale:Ge(e,s),refetch:this.refetch,promise:this.#r,isEnabled:re(s.enabled,e)!==!1};if(this.options.experimental_prefetchInRender){const F=L=>{R.status==="error"?L.reject(R.error):R.data!==void 0&&L.resolve(R.data)},G=()=>{const L=this.#r=R.promise=Ue();F(L)},Q=this.#r;switch(Q.status){case"pending":e.queryHash===n.queryHash&&F(Q);break;case"fulfilled":(R.status==="error"||R.data!==Q.value)&&G();break;case"rejected":(R.status!=="error"||R.error!==Q.reason)&&G();break}}return R}updateResult(){const e=this.#t,s=this.createResult(this.#e,this.options);if(this.#i=this.#e.state,this.#u=this.options,this.#i.data!==void 0&&(this.#h=this.#e),Fe(s,e))return;this.#t=s;const n=()=>{if(!e)return!0;const{notifyOnChangeProps:r}=this.options,a=typeof r=="function"?r():r;if(a==="all"||!a&&!this.#m.size)return!0;const i=new Set(a??this.#m);return this.options.throwOnError&&i.add("error"),Object.keys(this.#t).some(o=>{const f=o;return this.#t[f]!==e[f]&&i.has(f)})};this.#C({listeners:n()})}#w(){const e=this.#s.getQueryCache().build(this.#s,this.options);if(e===this.#e)return;const s=this.#e;this.#e=e,this.#f=e.state,this.hasListeners()&&(s?.removeObserver(this),e.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#S()}#C(e){Ze.batch(()=>{e.listeners&&this.listeners.forEach(s=>{s(this.#t)}),this.#s.getQueryCache().notify({query:this.#e,type:"observerResultsUpdated"})})}};function qt(e,s){return re(s.enabled,e)!==!1&&e.state.data===void 0&&!(e.state.status==="error"&&s.retryOnMount===!1)}function qe(e,s){return qt(e,s)||e.state.data!==void 0&&_e(e,s,s.refetchOnMount)}function _e(e,s,n){if(re(s.enabled,e)!==!1&&xe(s.staleTime,e)!=="static"){const r=typeof n=="function"?n(e):n;return r==="always"||r!==!1&&Ge(e,s)}return!1}function Ve(e,s,n,r){return(e!==s||re(r.enabled,e)===!1)&&(!n.suspense||e.state.status!=="error")&&Ge(e,n)}function Ge(e,s){return re(s.enabled,e)!==!1&&e.isStaleByTime(xe(s.staleTime,e))}function Vt(e,s){return!Fe(e.getCurrentResult(),s)}var it=u.createContext(!1),Yt=()=>u.useContext(it);it.Provider;function Xt(){let e=!1;return{clearReset:()=>{e=!1},reset:()=>{e=!0},isReset:()=>e}}var Zt=u.createContext(Xt()),es=()=>u.useContext(Zt),ts=(e,s)=>{(e.suspense||e.throwOnError||e.experimental_prefetchInRender)&&(s.isReset()||(e.retryOnMount=!1))},ss=e=>{u.useEffect(()=>{e.clearReset()},[e])},rs=({result:e,errorResetBoundary:s,throwOnError:n,query:r,suspense:a})=>e.isError&&!s.isReset()&&!e.isFetching&&r&&(a&&e.data===void 0||ht(n,[e.error,r])),ns=e=>{if(e.suspense){const n=a=>a==="static"?a:Math.max(a??1e3,1e3),r=e.staleTime;e.staleTime=typeof r=="function"?(...a)=>n(r(...a)):n(r),typeof e.gcTime=="number"&&(e.gcTime=Math.max(e.gcTime,1e3))}},as=(e,s)=>e.isLoading&&e.isFetching&&!s,is=(e,s)=>e?.suspense&&s.isPending,Ye=(e,s,n)=>s.fetchOptimistic(e).catch(()=>{n.clearReset()});function os(e,s,n){const r=Yt(),a=es(),i=et(),o=i.defaultQueryOptions(e);i.getDefaultOptions().queries?._experimental_beforeQuery?.(o),o._optimisticResults=r?"isRestoring":"optimistic",ns(o),ts(o,a),ss(a);const f=!i.getQueryCache().get(o.queryHash),[x]=u.useState(()=>new s(i,o)),N=x.getOptimisticResult(o),C=!r&&e.subscribed!==!1;if(u.useSyncExternalStore(u.useCallback(d=>{const g=C?x.subscribe(Ze.batchCalls(d)):Re;return x.updateResult(),g},[x,C]),()=>x.getCurrentResult(),()=>x.getCurrentResult()),u.useEffect(()=>{x.setOptions(o)},[o,x]),is(o,N))throw Ye(o,x,a);if(rs({result:N,errorResetBoundary:a,throwOnError:o.throwOnError,query:i.getQueryCache().get(o.queryHash),suspense:o.suspense}))throw N.error;return i.getDefaultOptions().queries?._experimental_afterQuery?.(o,N),o.experimental_prefetchInRender&&!Oe&&as(N,r)&&(f?Ye(o,x,a):i.getQueryCache().get(o.queryHash)?.promise)?.catch(Re).finally(()=>{x.updateResult()}),o.notifyOnChangeProps?N:x.trackResult(N)}function ls(e,s){return os(e,Jt)}const ot=({line:e,onSave:s,onCancel:n})=>{const[r,a]=u.useState(e||""),i=u.useRef(null);u.useEffect(()=>{i.current&&i.current.focus()},[]);const o=()=>{s(r)},f=x=>{x.key==="Enter"?o():x.key==="Escape"&&n()};return t.jsxs("div",{className:"lyric-line-editor",children:[t.jsx("input",{ref:i,type:"text",value:r,onChange:x=>a(x.target.value),onKeyDown:f,placeholder:"Enter lyrics with [Chord] notation...",className:"lyric-input"}),t.jsxs("div",{className:"editor-controls",children:[t.jsx("button",{onClick:o,className:"save-button",children:"Save"}),t.jsx("button",{onClick:n,className:"cancel-button",children:"Cancel"})]})]})},cs=({line:e,index:s,id:n,editingLineIndex:r,editingEnabled:a,hoveredLineIndex:i,setHoveredLineIndex:o,handleEditLine:f,handleInsertAfter:x,handleDeleteLine:N,handleSaveLine:C,handleCancelEdit:d,renderLyricLine:g,isThisLinePending:b=!1,isDragDisabled:S=!1,isPendingDelete:j=!1,isAddingLine:p=!1,isPendingSave:P=!1})=>{const{attributes:_,listeners:E,setNodeRef:M,transform:A,transition:K,isDragging:R}=_t({id:n,disabled:S}),F={transform:Mt.Transform.toString(A),transition:K,opacity:R?.5:j?.6:1};return t.jsx("div",{ref:M,style:F,className:`lyric-line ${j?"pending-delete":""}`,onMouseEnter:()=>o(s),onMouseLeave:()=>o(null),children:r===s&&!p&&a?t.jsx(ot,{line:e,onSave:G=>C(G,s),onCancel:d}):t.jsxs("div",{className:"lyric-line-row",children:[t.jsx("div",{className:"lyric-content",children:g(e)}),P&&t.jsxs("div",{className:"pending-badge pending-save",children:[t.jsx(we,{size:"small"}),t.jsx("span",{className:"pending-text",children:"Saving..."})]}),j&&t.jsxs("div",{className:"pending-badge pending-delete-badge",children:[t.jsx(we,{size:"small"}),t.jsx("span",{className:"pending-text",children:"Deleting..."})]}),i===s&&a&&!j&&t.jsxs("div",{className:"lyric-controls",children:[t.jsx("button",{className:"control-button edit",onClick:G=>{G.stopPropagation(),f(s)},title:"Edit this line",children:t.jsx(Gt,{})}),t.jsx("button",{className:"control-button insert",onClick:G=>{G.stopPropagation(),x(s)},title:"Insert new line after this line",children:t.jsx(at,{})}),t.jsx("button",{className:"control-button delete",onClick:G=>{G.stopPropagation(),N(s)},title:"Delete this line",children:t.jsx(nt,{})}),t.jsx("div",{...S?{}:_,...S?{}:E,className:"drag-handle",title:S?"Drag disabled during update":"Drag to reorder",children:b?t.jsx(we,{size:"small"}):t.jsx(Ut,{})})]})]})})},us=({song:e,onPinChord:s,onUpdateSong:n,artist:r,editingEnabled:a=!0})=>{const{message:i}=Me.useApp(),[o,f]=u.useState(null),[x,N]=u.useState(!1),[C,d]=u.useState(null),[g,b]=u.useState(0),[S,j]=u.useState(!1),[p,P]=u.useState(""),[_,E]=u.useState(new Set),[M,A]=u.useState(null),[K,R]=u.useState(null),[F,G]=u.useState(new Set),[Q,L]=u.useState(!1),[U,D]=u.useState(!1),[W,ne]=u.useState(!1),V=tt(),X=ee(l=>l.chords.currentInstrument),c=ee(l=>l.chords.transposeBy?.[e.title]||0),y=ee(l=>l.chords.chordFingerings),O=ee(l=>l.songs.isGoogleDriveConnected),$=Lt(Je(Tt),Je(Et,{coordinateGetter:kt})),Z=l=>{const w=/\[(.*?)\]/g,T=[];return l?.forEach(k=>{let I;for(;(I=w.exec(k))!==null;)T.includes(I[1])||T.push(I[1])}),T},te=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],be={Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#",Bb:"A#"};function le(l,w){if(l.includes("/")){const[ae,Ae]=l.split("/"),Pe=le(ae,w),ve=le(Ae,w);return`${Pe}/${ve}`}const T=l.match(/^([A-G][b#]?)(.*)$/);if(!T)return l;let[,k,I]=T;be[k]&&(k=be[k]);let B=te.indexOf(k);if(B===-1)return l;let J=(B+w+12)%12;return te[J]+I}const q=(l=>{if(!l)return[];if(Array.isArray(l)&&l.length>0&&typeof l[0]=="string")return l;if(typeof l=="string")return l?l.split(`
`):[];if(Array.isArray(l)&&l.length>0&&Array.isArray(l[0])){const w=[];return l.forEach((T,k)=>{k>0&&w.push(""),T.forEach(I=>{if(I&&I.text){let B=I.text;I.chords&&I.chords.length>0&&(B=`[${I.chords[0]}]${B}`),w.push(B)}})}),w}return[]})(e.lyrics),Se=(e.chords||Z(q)).map(l=>g!==0?le(l,g):l),fe=l=>{f(l),N(!1)},Y=l=>{if(Q||F.size>0){i.warning("Please wait for current operation to complete before inserting a new line.");return}N(!0),f(l===-1?0:l+1)},Ce=async(l,w)=>{const T=[...q];if(x){L(!0);const k=o!==null&&o<=q.length?o:T.length;T.splice(k,0,l),A(T),E(I=>new Set([...I,k])),f(null),N(!1),n({...e,lyrics:T}).then(()=>{i.success("Line added successfully!"),A(null),L(!1),E(I=>{const B=new Set(I);return B.delete(k),B}),f(null),N(!1)}).catch(I=>{console.error("Failed to add line:",I),i.error("Failed to add new line. Please try again."),A(null),L(!1),E(B=>{const J=new Set(B);return J.delete(k),J}),N(!0),f(null)})}else L(!0),E(k=>new Set([...k,w])),T[w]=l,A(T),f(null),n({...e,lyrics:T}).then(()=>{i.success("Line updated successfully!"),A(null),L(!1),E(k=>{const I=new Set(k);return I.delete(w),I})}).catch(k=>{console.error("Failed to update line:",k),i.error("Failed to update line. Please try again."),A(null),L(!1),E(I=>{const B=new Set(I);return B.delete(w),B}),f(w)})},je=()=>{f(null),N(!1)},ge=async l=>{if(Q||F.has(l)){i.warning("Please wait for current operation to complete before deleting this line.");return}L(!0),G(T=>new Set([...T,l]));const w=[...q];w.splice(l,1),A(w);try{await n({...e,lyrics:w}),i.success("Line deleted successfully!"),A(null),L(!1),G(T=>{const k=new Set(T);return k.delete(l),k})}catch(T){console.error("Failed to delete line:",T),i.error("Failed to delete line. Please try again."),A(null),L(!1),G(k=>{const I=new Set(k);return I.delete(l),I})}},Te=async l=>{const{active:w,over:T}=l;if(w.id!==T.id){L(!0);const k=q.findIndex((J,ae)=>ae.toString()===w.id),I=q.findIndex((J,ae)=>ae.toString()===T.id),B=$t(q,k,I);A(B),R(I),n({...e,lyrics:B}).then(()=>{i.success("Lines reordered successfully!"),A(null),L(!1),R(null)}).catch(J=>{console.error("Failed to reorder lines:",J),i.error("Failed to reorder lines. Please try again."),A(null),L(!1),R(null)})}},Ie=()=>{P(q.join(`
`)),j(!0)},h=async()=>{ne(!0);try{const l=p.split(`
`).filter(w=>w.trim()!=="");await n({...e,lyrics:l,chords:Z(l)}),j(!1),i.success("Song lyrics saved successfully!")}catch(l){console.error("Failed to save whole song:",l),i.error("Failed to save song. Please try again.")}finally{ne(!1)}},m=l=>{if(!l)return!1;const w=l.message||l||"";return["User not signed in to Google Drive","Expected OAuth 2 access token","login cookie or other valid authentication credential","Invalid Credentials","Authentication failed","unauthorized_client","invalid_token","expired_token","access_denied","token_expired","Request had invalid authentication credentials"].some(k=>w.toLowerCase().includes(k.toLowerCase()))},v=()=>{z()},z=async()=>{try{await V(rt({artistName:r.name,albumTitle:e.album?.title,songTitle:e.title,isGoogleDriveConnected:O})).unwrap(),i.success("Song deleted successfully!"),V(yt())}catch(l){console.error("Failed to delete song:",l),m(l)?(V(he(!1)),V(me(null)),i.error("Your Google Drive session has expired. Please sign in again to delete songs.")):i.error(l.message||"Failed to delete song. Please try again.")}},H=()=>{j(!1),P("")},de=l=>{const w=/\[(.*?)\]/g,T=[];let k=l,I;for(;(I=w.exec(l))!==null;)T.push({chord:I[1],position:I.index,length:I[0].length});k=k.replace(/\[(.*?)\]/g,"");const B=T.map((J,ae)=>{let Ae=0;for(let ve=0;ve<ae;ve++)Ae+=T[ve].length;const Pe=g!==0?le(J.chord,g):J.chord;return{...J,chord:Pe,position:J.position-Ae}});return t.jsxs("div",{className:"lyric-line-with-chords",children:[t.jsx("div",{className:"chord-labels",children:B.map((J,ae)=>t.jsx("span",{className:"chord-label",style:{left:`${J.position}ch`},onClick:()=>s(J.chord),children:J.chord},`chord-${ae}`))}),t.jsx("div",{className:"lyric-text-only",children:k})]})};$e.useEffect(()=>{b(c)},[e.title]);const se=()=>{b(l=>l+1),V(pt(e.title))},ce=()=>{b(l=>l-1),V(gt(e.title))},ue=async()=>{D(!0);try{const l=q.map(T=>{const k=/\[([^\]]+)\]/g;return T.replace(k,(I,B)=>`[${le(B,g)}]`)}),w={...e,lyrics:l,chords:Z(l),chordFingerings:y};await n(w),b(0),i.success("Transposed lyrics saved successfully!")}catch(l){console.error("Failed to save transposed lyrics:",l),i.error("Failed to save transposed lyrics. Please try again.")}finally{D(!1)}};return t.jsxs("div",{className:"song-detail",children:[t.jsxs("div",{className:"chords-section",children:[t.jsxs("div",{className:"chords-header",children:[t.jsxs("div",{className:"chords-header-left",children:[t.jsx("button",{className:"transpose-btn",title:"Transpose Down",onClick:ce,children:"-"}),t.jsxs("span",{className:"transpose-label",children:["Transpose: ",g>0?`+${g}`:g," semitones"]}),t.jsx("button",{className:"transpose-btn",title:"Transpose Up",onClick:se,children:"+"}),t.jsxs("button",{className:"save-transpose-btn",onClick:ue,disabled:g===0||U,children:[U&&t.jsx(we,{size:"small"}),"Save Transposed Lyrics"]})]}),t.jsxs("div",{className:"instrument-selector",children:[t.jsx("label",{htmlFor:"instrument-select",className:"instrument-label",children:"Instrument:"}),t.jsxs("select",{id:"instrument-select",value:X,onChange:l=>V(mt(l.target.value)),className:"instrument-select",children:[t.jsx("option",{value:"ukulele",children:"Ukulele"}),t.jsx("option",{value:"guitar",children:"Guitar"}),t.jsx("option",{value:"piano",children:"Piano"}),t.jsx("option",{value:"bassGuitar",children:"Bass Guitar"}),t.jsx("option",{value:"bassUkulele",children:"Bass Ukulele"}),t.jsx("option",{value:"baritoneUkulele",children:"Baritone Ukulele"})]})]})]}),t.jsx("div",{className:"chord-container",children:Se.map(l=>t.jsx("div",{className:"chord-item",onClick:()=>s(l),children:t.jsx(ft,{chord:l,instrument:X})},l))})]}),t.jsx("div",{className:"lyrics-section",children:t.jsxs("div",{className:"lyrics-container",children:[t.jsxs("div",{className:"song-header-row",children:[t.jsx("div",{className:"song-header-main",children:t.jsxs("div",{className:"song-header-titles",children:[t.jsx("h3",{className:"song-header-title",children:e.title}),t.jsx("i",{className:"song-header-artist",children:r.name}),e.album&&e.album.title&&t.jsxs("span",{className:"song-header-meta",children:["â€¢ ",e.album.title]})]})}),t.jsxs("div",{className:"song-header-actions",children:[a&&!S&&t.jsxs(t.Fragment,{children:[t.jsxs("button",{className:"edit-whole-song-btn",onClick:Ie,children:[t.jsx(It,{})," Edit Whole Song"]}),t.jsxs("button",{className:"delete-song-btn",onClick:()=>{st.confirm({title:"Delete song?",content:`Are you sure you want to delete "${e.title}" by ${r?.name||"Unknown Artist"}?`,okText:"Delete",cancelText:"Cancel",onOk:()=>v()})},children:[t.jsx(nt,{})," Delete Song"]})]}),S&&t.jsxs("div",{className:"save-cancel-row",children:[t.jsxs("button",{className:"save-whole-song-btn",onClick:h,disabled:W,children:[W?t.jsx(we,{size:"small"}):t.jsx(Pt,{}),"Save"]}),t.jsx("button",{className:"cancel-whole-song-btn",onClick:H,children:"Cancel"})]})]})]}),S?t.jsx("textarea",{value:p,onChange:l=>P(l.target.value),className:"whole-song-textarea"}):t.jsx(Dt,{sensors:$,collisionDetection:Ft,onDragEnd:Te,children:t.jsxs(Rt,{items:(M||q).map((l,w)=>w.toString()),strategy:Ot,children:[(M||q).map((l,w)=>t.jsx(cs,{id:w.toString(),index:w,line:l,editingLineIndex:o,editingEnabled:a,hoveredLineIndex:C,setHoveredLineIndex:d,handleEditLine:fe,handleInsertAfter:Y,handleDeleteLine:ge,handleSaveLine:Ce,handleCancelEdit:je,renderLyricLine:de,isThisLinePending:K===w,isDragDisabled:Q||F.size>0,isPendingDelete:F.has(w),isAddingLine:x&&o===w,isPendingSave:_.has(w)},w)),x&&o===(M||q).length&&t.jsx(ot,{line:"",onSave:l=>Ce(l,(M||q).length),onCancel:je,isAdding:!0})]})}),a&&!S&&t.jsx("div",{className:"add-line-row",children:t.jsxs("button",{className:"add-line-btn",onClick:()=>Y((M||q).length-1),disabled:Q||F.size>0,children:[t.jsx(at,{})," Add Line"]})})]})})]})};class ds{apiEndpoint;albumCache;cacheExpiry;constructor(){this.apiEndpoint="https://songs-spotify-api.ai-recipe-notepad.workers.dev/api/spotify-search",this.albumCache=new Map,this.cacheExpiry=1440*60*1e3}async searchAlbumArt(s,n=null){try{const r=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({artist:s,album:n,searchType:"album"})});if(!r.ok)throw new Error(`Album search request failed: ${r.status}`);const a=await r.json();if(a.albums?.items?.length>0){const i=a.albums.items[0];return{albumArt:i.images?.[0]?.url||null,albumName:i.name,artistName:i.artists?.[0]?.name,releaseDate:i.release_date,spotifyUrl:i.external_urls?.spotify,totalTracks:i.total_tracks}}else if(a.tracks?.items?.length>0){const i=a.tracks.items[0];return{albumArt:i.album.images?.[0]?.url||null,albumName:i.album.name,artistName:i.artists?.[0]?.name,trackName:i.name,releaseDate:i.album.release_date,spotifyUrl:i.external_urls?.spotify}}return null}catch(r){return console.error("Spotify album search failed:",r),null}}async searchTrack(s,n,r=null){try{const a=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({artist:s,track:n,album:r})});if(!a.ok)throw new Error(`Search request failed: ${a.status}`);const i=await a.json();if(i.tracks?.items?.length>0){const o=i.tracks.items[0];return{albumArt:o.album.images?.[0]?.url||null,albumName:o.album.name,artistName:o.artists?.[0]?.name,trackName:o.name,releaseDate:o.album.release_date,spotifyUrl:o.external_urls?.spotify}}return null}catch(a){return console.error("Spotify search failed:",a),null}}async getAlbumsForArtist(s){if(!s||s.trim()==="")return[];const n=s.toLowerCase().trim(),r=this.albumCache.get(n);if(r&&Date.now()-r.timestamp<this.cacheExpiry)return r.albums;try{const a=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({artist:s,searchType:"artist-albums"})});if(!a.ok)throw a.status===404?console.warn("Spotify API endpoint not configured - album suggestions disabled"):console.error(`Artist albums search failed: ${a.status}`),new Error(`Artist albums search failed: ${a.status}`);const i=await a.json();if(i.error)throw console.warn("Spotify API error:",i.error),new Error(i.error);let o=[];return i.albums?.items&&(o=[...new Set(i.albums.items.map(f=>f.name))].sort()),this.albumCache.set(n,{albums:o,timestamp:Date.now()}),o}catch(a){return console.error("Failed to get artist albums:",a),this.albumCache.set(n,{albums:[],timestamp:Date.now()}),[]}}async searchArtists(s){if(!s||s.trim()==="")return[];const n=`artist_search_${s.toLowerCase().trim()}`,r=this.albumCache.get(n);if(r&&Date.now()-r.timestamp<this.cacheExpiry)return r.artists;try{const a=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({artist:s,searchType:"artist"})});if(!a.ok)throw console.error(`Artist search failed: ${a.status}`),new Error(`Artist search failed: ${a.status}`);const i=await a.json();if(i.error)throw console.warn("Spotify API error:",i.error),new Error(i.error);let o=[];return i.artists?.items&&(o=[...new Set(i.artists.items.map(f=>f.name))].sort()),this.albumCache.set(n,{artists:o,timestamp:Date.now()}),o}catch(a){return console.error("Failed to search artists:",a),this.albumCache.set(n,{artists:[],timestamp:Date.now()}),[]}}clearAlbumCache(){this.albumCache.clear()}getAlbumCacheStats(){return{size:this.albumCache.size,entries:Array.from(this.albumCache.keys())}}getAlbumArtUrl(s){return s?.albumArt?s.albumArt:null}async getTracksFromAlbum(s,n){if(!s||!n||s.trim()===""||n.trim()==="")return[];const r=`album_tracks_${s.toLowerCase().trim()}_${n.toLowerCase().trim()}`,a=this.albumCache.get(r);if(a&&Date.now()-a.timestamp<this.cacheExpiry)return a.tracks;try{const i=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({artist:s,album:n,searchType:"tracks"})});if(!i.ok)throw console.error(`Album tracks search failed: ${i.status}`),new Error(`Album tracks search failed: ${i.status}`);const o=await i.json();if(o.error)throw console.warn("Spotify API error:",o.error),new Error(o.error);let f=[];return o.tracks?.items&&(f=[...new Set(o.tracks.items.map(x=>x.name))].sort()),this.albumCache.set(r,{tracks:f,timestamp:Date.now()}),f}catch(i){return console.error("Failed to get album tracks:",i),this.albumCache.set(r,{tracks:[],timestamp:Date.now()}),[]}}async searchTracks(s,n=null){if(!s||s.trim()==="")return[];const r=`track_search_${s.toLowerCase().trim()}_${n?n.toLowerCase().trim():"any"}`,a=this.albumCache.get(r);if(a&&Date.now()-a.timestamp<this.cacheExpiry)return a.tracks;try{const i=await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({track:s,artist:n,searchType:"track-search"})});if(!i.ok)throw console.error(`Track search failed: ${i.status}`),new Error(`Track search failed: ${i.status}`);const o=await i.json();if(o.error)throw console.warn("Spotify API error:",o.error),new Error(o.error);let f=[];return o.tracks?.items&&(f=[...new Set(o.tracks.items.map(x=>x.name))].sort()),this.albumCache.set(r,{tracks:f,timestamp:Date.now()}),f}catch(i){return console.error("Failed to search tracks:",i),this.albumCache.set(r,{tracks:[],timestamp:Date.now()}),[]}}}const ke=new ds,hs="albumArt_",ms=24,fs=(e,s)=>`${hs}${e}_${s||"unknown"}`.replace(/[^a-zA-Z0-9_]/g,"_"),gs=e=>{try{const s=localStorage.getItem(e);if(s){const{data:n,timestamp:r}=JSON.parse(s),a=Date.now(),i=r+ms*60*60*1e3;if(a<i)return n;localStorage.removeItem(e)}}catch(s){console.warn("Cache read error:",s)}return null},ps=(e,s)=>{try{const n={data:s,timestamp:Date.now()};localStorage.setItem(e,JSON.stringify(n))}catch(n){console.warn("Cache write error:",n)}},ys=({artist:e,album:s,size:n=150})=>{const[r,a]=u.useState(null),[i,o]=u.useState(!1),[f,x]=u.useState(null);return u.useEffect(()=>{(async()=>{if(!e)return;const C=fs(e,s),d=gs(C);if(d){console.log("ðŸŽ¯ Cache hit for:",e,s?`- ${s}`:"(any album)"),a(d);return}o(!0),x(null);try{console.log("ðŸŒ API call for:",e,s?`- ${s}`:"(searching artist albums)");const g=await ke.searchAlbumArt(e,s);a(g),g&&ps(C,g)}catch(g){let b="Failed to load album art";g.name==="TypeError"&&g.message.includes("Failed to fetch")?b="Network error: Cannot reach Spotify API service":g.message.includes("JSON")?b=`JSON Parse Error: ${g.message}`:g.message.includes("404")?b="API endpoint not found (404)":g.message.includes("401")?b="Authentication failed (401) - Check Spotify credentials":g.message.includes("403")?b="Access forbidden (403) - API quota exceeded?":g.message.includes("500")?b="Server error (500) - Spotify API or Worker issue":g.message&&(b=`Error: ${g.message}`),x(b),console.error("Album art fetch error details:",{name:g.name,message:g.message,stack:g.stack,artist:e,album:s})}finally{o(!1)}})()},[e,s]),i?t.jsx("div",{className:"album-art-placeholder",style:{width:n,height:n},children:t.jsx("div",{className:"album-art-loading-text",children:"Loading..."})}):f||!r?.albumArt?t.jsxs("div",{className:"album-art-placeholder album-art-missing",style:{width:n,height:n},children:[t.jsx("div",{className:"album-art-icon",children:"â™ª"}),t.jsx("div",{className:"album-art-text",children:"No album art found"})]}):t.jsx("div",{className:"album-art-wrapper",style:{width:n,height:n},children:t.jsx("img",{src:r.albumArt,alt:`${r.albumName} album art`,className:"album-art-image",style:{width:n,height:n},onError:N=>{N.target.style.display="none",x("Image failed to load")}})})};function bs(e){const n=e.replace(/\[.*?\]/g,"").split(`
`),r=[];let a=0;for(;a<n.length;){let i=n[a].trim();if(/^\[.*?(?::.+)?\]$/.test(i)){(r.length===0||r[r.length-1]!=="")&&r.push(""),a++;continue}if(!i){(r.length===0||r[r.length-1]!=="")&&r.push(""),a++;continue}i=i.replace(/N\.C\./g,"    ");const o=/[A-G][#b]?(?:maj|min|m|sus|aug|dim|add)?[0-9]*(?:\([^)]+\))?(?:sus[0-9]*)?(?:[#b][0-9]+)*(?:\/[A-G][#b]?)?/g,f=i.match(o)||[],x=i.replace(o,"").trim();if(f.length>0&&(x===""||/^\s*$/.test(x))){const C=[];let d;const b=i.replace(/\s+/g," ").trim().match(/^[A-G][#b]?(?:maj|min|m|sus|aug|dim|add)?[0-9]*(?:\([^)]+\))?(?:sus[0-9]*)?(?:[#b][0-9]+)*(?:\/[A-G][#b]?)?$/);if(b){let p=a+1;for(;p<n.length&&!n[p].trim();)p++;if(p<n.length){const P=n[p].trim(),_=P.match(o)||[],E=P.replace(o,"").trim(),M=_.length>0&&(E===""||/^\s*$/.test(E)),A=/^\[.*?(?::.+)?\]$/.test(P);if(!M&&!A){r.push(`[${b[0]}]${P}`),a=p+1;continue}}r.push(`[${b[0]}]`),a++;continue}const S=/[A-G][#b]?(?:maj|min|m|sus|aug|dim|add)?[0-9]*(?:\([^)]+\))?(?:sus[0-9]*)?(?:[#b][0-9]+)*(?:\/[A-G][#b]?)?/g;for(;(d=S.exec(i))!==null;)C.push({chord:d[0],position:d.index});let j=a+1;for(;j<n.length&&!n[j].trim();)j++;if(j<n.length){const p=n[j].trim(),P=p.match(o)||[],_=p.replace(o,"").trim(),E=P.length>0&&(_===""||/^\s*$/.test(_)),M=/^\[.*?(?::.+)?\]$/.test(p);if(!E&&!M){const A=p,K=A.split(""),R=[];C.forEach(({chord:U,position:D})=>{let W=Math.min(D,A.length);if(W>=A.length)W=A.length;else for(;W<A.length&&W>0&&/\S/.test(A[W-1])&&/\S/.test(A[W]);)W++;R.push({pos:W,text:`[${U}]`})}),R.sort((U,D)=>D.pos-U.pos);const F=A.length,G=[],Q=[];R.forEach(({pos:U,text:D})=>{U>=F?G.push({pos:U,text:D}):Q.push({pos:U,text:D})}),Q.forEach(({pos:U,text:D})=>{K.splice(U,0,D)});let L=K.join("");if(G.length>0){const U=G.sort((D,W)=>{const ne=C.find(X=>X.chord===D.text.slice(1,-1))?.position||0,V=C.find(X=>X.chord===W.text.slice(1,-1))?.position||0;return ne-V});for(let D=0;D<U.length;D++){const W=U[D].text,ne=W.slice(1,-1);if(L+=W,D<U.length-1){const V=ne.length+1;L+=" ".repeat(V)}}}r.push(L),a=j+1}else{let A="";C.forEach(({chord:K},R)=>{if(A+=`[${K}]`,R<C.length-1){const F=K.length+1;A+=" ".repeat(F)}}),r.push(A),a++}}else{let p="";C.forEach(({chord:P},_)=>{if(p+=`[${P}]`,_<C.length-1){const E=P.length+1;p+=" ".repeat(E)}}),r.push(p),a++}}else r.push(i),a++}for(;r[0]==="";)r.shift();for(;r[r.length-1]==="";)r.pop();return r.join(`
`)}const De="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20100%20100'%20width='100'%20height='100'%3e%3ccircle%20cx='50'%20cy='50'%20r='50'%20fill='%231DB954'/%3e%3cpath%20d='M75.5%2041.5c-12.5-7.5-33-8-45-4.5-1.5%200.5-3-0.5-3.5-2s0.5-3%202-3.5c13.5-4%2035.5-3%2049.5%205%201.5%200.5%201.5%202.5%201%204s-2.5%201.5-4%201z'%20fill='%23000'/%3e%3cpath%20d='M72.5%2051c-10.5-6.5-28-7-38-4-1.5%200.5-2.5-0.5-3-1.5s0.5-2.5%201.5-3c11.5-3.5%2031-3%2043%204.5%201%200.5%201.5%202%201%203s-2%201.5-3%201c-0.5%200-1-0.5-1.5-0z'%20fill='%23000'/%3e%3cpath%20d='M69.5%2060c-9-5.5-24-6-32-3.5-1%200.5-2-0.5-2.5-1.5s0.5-2%201.5-2.5c9.5-3%2026-2.5%2036%204%201%200.5%201%201.5%200.5%202.5s-1.5%201-2.5%201c-0.5%200-0.5%200-1%200z'%20fill='%23000'/%3e%3c/svg%3e",{Option:pe}=Le,Xe=({song:e,artist:s,album:n,onSave:r,onCancel:a,isGoogleDriveConnected:i,isNewSong:o=!1,library:f=null,lyricsRef:x})=>{const[N,C]=u.useState(()=>e?.title||""),[d,g]=u.useState(()=>s?.name||""),[b,S]=u.useState(()=>n?.title||""),[j,p]=u.useState([]),[P,_]=u.useState(!1),[E,M]=u.useState([]),[A,K]=u.useState(!1),[R,F]=u.useState([]),[G,Q]=u.useState(!1),[L,U]=u.useState(()=>typeof e?.lyrics=="string"?e.lyrics:""),[D,W]=u.useState([]),[ne,V]=u.useState(!1),X=u.useRef(null),c=u.useRef(null),y=x??c,[O,$]=u.useState(""),[Z,te]=u.useState(!1);u.useEffect(()=>{if(d&&d.trim()!==""){const m=setTimeout(async()=>{_(!0);try{const v=await ke.getAlbumsForArtist(d);p(v)}catch(v){console.log("Spotify album suggestions unavailable:",v.message),p([])}finally{_(!1)}},500);return()=>clearTimeout(m)}else p([]),_(!1)},[d]),u.useEffect(()=>{if(d&&d.trim()!==""&&d.length>0){const m=setTimeout(async()=>{K(!0);try{const v=await ke.searchArtists(d);M(v)}catch(v){console.log("Spotify artist suggestions unavailable:",v.message),M([])}finally{K(!1)}},300);return()=>clearTimeout(m)}else M([]),K(!1)},[d]),u.useEffect(()=>{if(d&&b&&d.trim()!==""&&b.trim()!==""){const m=setTimeout(async()=>{Q(!0);try{const v=await ke.getTracksFromAlbum(d,b);F(v)}catch(v){console.log("Spotify track suggestions unavailable:",v.message),F([])}finally{Q(!1)}},300);return()=>clearTimeout(m)}else F([]),Q(!1)},[d,b]);const be=u.useMemo(()=>{if(!b||b.trim()==="")return j;const h=b.toLowerCase().trim();return j.filter(m=>m.toLowerCase().includes(h))},[j,b]),le=u.useMemo(()=>{if(!d||d.trim()==="")return E;const h=d.toLowerCase().trim();return E.filter(m=>m.toLowerCase().includes(h))},[E,d]),Ee=u.useMemo(()=>{if(!f?.artists)return[];let h=f.artists.map(m=>m.name).sort();if(d&&d.trim()!==""){const m=d.toLowerCase().trim();h=h.filter(v=>v.toLowerCase().includes(m))}return h},[f,d]),q=u.useMemo(()=>{if(!f?.artists||!d)return[];const h=f.artists.find(v=>v.name===d);if(!h?.albums)return[];let m=h.albums.map(v=>v.title).sort();if(b&&b.trim()!==""){const v=b.toLowerCase().trim();m=m.filter(z=>z.toLowerCase().includes(v))}return m},[f,d,b]),Se=u.useMemo(()=>{if(!f?.artists||!d||!b)return[];const h=f.artists.find(v=>v.name===d);if(!h?.albums)return[];const m=h.albums.find(v=>v.title===b);return m?.songs?m.songs.map(v=>v.title.toLowerCase().trim()):[]},[f,d,b]),fe=u.useMemo(()=>{if(!R||R.length===0)return[];let h=R.filter(m=>!Se.includes(m.toLowerCase().trim()));if(N&&N.trim()!==""){const m=N.toLowerCase().trim();h=h.filter(v=>v.toLowerCase().includes(m))}return h},[R,Se,N]),Y=u.useMemo(()=>{if(!f?.artists||!d||!b)return[];const h=f.artists.find(z=>z.name===d);if(!h?.albums)return[];const m=h.albums.find(z=>z.title===b);if(!m?.songs)return[];let v=m.songs.map(z=>z.title).sort();if(N&&N.trim()!==""){const z=N.toLowerCase().trim();v=v.filter(H=>H.toLowerCase().includes(z))}return v},[f,d,b,N]),Ce=()=>{if(O.trim()){const m=bs(O).split(`
`).filter(v=>v.trim()!=="").join(`
`);U(m),$(""),te(!1),ie.success("Lyrics converted successfully!")}};u.useEffect(()=>{const h=/\[([^\]]+)\]/g,m=[];let v;const z=typeof L=="string"?L:"";for(;(v=h.exec(z))!==null;){const H=v[1];m.includes(H)||m.push(H)}if(W(m.sort()),X.current){const H=X.current;H.style.height="auto",H.style.height=Math.max(400,H.scrollHeight)+"px"}},[L]),u.useEffect(()=>{const h=m=>{if(m.ctrlKey&&!m.shiftKey&&!m.altKey){const v=parseInt(m.key);if(v>=1&&v<=9){const z=v-1;z<D.length&&(m.preventDefault(),ge(D[z]))}else if(m.key==="0"&&D.length>=10)m.preventDefault(),ge(D[9]);else{const H=["q","w","e","r","t","y","u","i","o","p"].indexOf(m.key.toLowerCase());H!==-1&&D.length>10+H&&(m.preventDefault(),ge(D[10+H]))}}};return document.addEventListener("keydown",h),()=>{document.removeEventListener("keydown",h)}},[D]);const je=()=>{const h=typeof L=="string"?L:"";if(!h)return t.jsx("div",{className:"preview-empty",children:"No lyrics to preview"});const m=h.split(`
`);return t.jsx("div",{className:"lyrics-preview",children:m.map((v,z)=>{if(!v.trim())return t.jsx("div",{className:"preview-line empty-line",children:"Â "},z);const H=/\[(.*?)\]/g,de=[];let se=v,ce;for(;(ce=H.exec(v))!==null;)de.push({chord:ce[1],position:ce.index,length:ce[0].length});se=se.replace(/\[(.*?)\]/g,"");const ue=de.map((l,w)=>{let T=0;for(let k=0;k<w;k++)T+=de[k].length;return{...l,position:l.position-T}});return t.jsxs("div",{className:"lyric-line-with-chords",children:[t.jsx("div",{className:"chord-labels",children:ue.map((l,w)=>t.jsx("span",{className:"chord-label",style:{left:`${l.position}ch`},children:l.chord},`chord-${w}`))}),t.jsx("div",{className:"lyric-text-only",children:se})]},z)})})},ge=async h=>{const m=X.current;if(!m)return;const v=m.selectionStart,z=m.selectionEnd,H=L.slice(0,v),de=L.slice(z),se=`[${h}]`,ce=H+se+de;U(ce);try{await navigator.clipboard.writeText(se),ie.success(`${se} copied to clipboard`)}catch(ue){console.error("Failed to copy to clipboard:",ue),ie.info(`${se} inserted`)}setTimeout(()=>{m.focus();const ue=v+se.length;m.setSelectionRange(ue,ue)},0)},Te=async()=>{if(o){if(!N.trim()){ie.error("Please enter a song title");return}if(!d.trim()){ie.error("Please enter an artist name");return}if(!b.trim()){ie.error("Please enter an album title");return}}if(!i&&!o){ie.error("Please sign in to Google Drive to save changes");return}V(!0);try{if(o)await r({title:N.trim(),artist:d.trim(),album:b.trim(),lyrics:L});else{const h={...e,title:N.trim(),lyrics:L,updatedAt:new Date().toISOString()};await r(h,{artist:d.trim(),album:b.trim()})}ie.success(o?"Song created successfully!":"Song saved successfully!")}catch(h){console.error("Failed to save song:",h),ie.error(`Failed to ${o?"create":"save"} song. Please try again.`)}finally{V(!1)}},Ie=()=>{(o?N.trim()!==""||d.trim()!==""||b.trim()!==""||L.trim()!=="":L!==(e?.lyrics||""))?st.confirm({title:"Unsaved changes",content:"You have unsaved changes. Are you sure you want to cancel?",okText:"Yes",cancelText:"No",onOk:()=>a()}):a()};return t.jsxs("div",{className:"song-editor",children:[t.jsx("div",{className:"song-editor-header",children:t.jsx("div",{className:"song-info",children:t.jsxs("div",{className:"song-form",children:[t.jsx("div",{className:"form-row",children:t.jsxs("div",{className:"form-group",children:[t.jsx("label",{children:"Artist"}),t.jsxs(Le,{value:d,"data-testid":"input-artist",onChange:g,placeholder:"Type to search for artists",size:"large",showSearch:!0,allowClear:!0,loading:A,className:"full-width-select",filterOption:!1,onSearch:g,notFoundContent:A?"Searching...":"No artists found",children:[Ee.map((h,m)=>t.jsxs(pe,{value:h,children:["ðŸ“š ",h]},`library-artist-${m}-${h}`)),le.map((h,m)=>t.jsxs(pe,{value:h,children:[t.jsx("img",{src:De,alt:"Spotify",className:"spotify-icon"}),h]},`spotify-artist-${m}-${h}`))]})]})}),t.jsx("div",{className:"form-row",children:t.jsxs("div",{className:"form-group",children:[t.jsx("label",{children:"Album"}),t.jsxs(Le,{value:b,"data-testid":"input-album",onChange:S,placeholder:"Type to search for albums",size:"large",showSearch:!0,allowClear:!0,loading:P,className:"full-width-select",filterOption:!1,onSearch:S,notFoundContent:P?"Loading albums...":"No albums found",children:[q.map((h,m)=>t.jsxs(pe,{value:h,children:["ðŸ“š ",h]},`library-album-${m}-${h}`)),be.map((h,m)=>t.jsxs(pe,{value:h,children:[t.jsx("img",{src:De,alt:"Spotify",className:"spotify-icon"}),h]},`spotify-album-${m}-${h}`))]})]})}),t.jsx("div",{className:"form-row",children:t.jsxs("div",{className:"form-group",children:[t.jsx("label",{children:"Title"}),t.jsxs(Le,{value:N,"data-testid":"input-title",onChange:C,placeholder:"Type to search for songs",size:"large",showSearch:!0,allowClear:!0,loading:G,className:"full-width-select",filterOption:!1,onSearch:C,notFoundContent:G?"Loading tracks...":"No tracks found",children:[Y.map((h,m)=>t.jsxs(pe,{value:h,children:["ðŸ“š ",h]},`library-${m}-${h}`)),fe.map((h,m)=>t.jsxs(pe,{value:h,children:[t.jsx("img",{src:De,alt:"Spotify",className:"spotify-icon"}),h]},`spotify-${m}-${h}`))]})]})})]})})}),t.jsxs("div",{className:"editor-main",children:[t.jsxs("div",{className:"editor-pane",ref:y,children:[t.jsxs("div",{className:"editor-header",children:[t.jsxs("h3",{children:["Edit Lyrics ",t.jsx("small",{children:"(use [chord] format)"})]}),t.jsxs("div",{className:"ug-conversion-compact",children:[t.jsx(oe,{type:"default",onClick:()=>te(!Z),size:"small",className:"ug-toggle-btn",children:Z?"â–¼ Hide UG Converter":"â–¶ Convert from Ultimate Guitar"}),Z&&t.jsxs("div",{className:"conversion-content",children:[t.jsx("textarea",{value:O,onChange:h=>$(h.target.value),placeholder:"Paste Ultimate Guitar format lyrics here...",className:"conversion-textarea-compact",rows:4,spellCheck:!1}),t.jsxs("div",{className:"conversion-actions",children:[t.jsx(oe,{type:"primary",onClick:Ce,disabled:!O.trim(),size:"small",children:"Convert to Inline Format"}),t.jsx(oe,{type:"text",onClick:()=>{$(""),te(!1)},size:"small",children:"Cancel"})]})]})]})]}),D.length>0&&t.jsxs("div",{className:"chord-palette-ribbon",children:[t.jsx("h4",{children:"Chord Palette (click to insert or use Ctrl+1-9, Ctrl+0):"}),t.jsx("div",{className:"chord-buttons",children:D.map((h,m)=>t.jsxs("button",{className:"chord-button",onClick:()=>ge(h),title:`Insert [${h}] at cursor position and copy to clipboard. Shortcut: Ctrl+${m<9?m+1:0}`,children:[t.jsx("span",{className:"chord-text",children:h}),m<10&&t.jsxs("span",{className:"chord-shortcut",children:["Ctrl+",m<9?m+1:0]})]},m))})]}),t.jsx("textarea",{ref:X,value:L,onChange:h=>U(h.target.value),placeholder:"Enter lyrics with chords in [chord] format...",className:`lyrics-editor${D.length>0?" has-chord-palette":""}`,spellCheck:!1}),t.jsx("div",{className:"editor-help",children:t.jsxs("p",{children:[t.jsx("strong",{children:"Tip:"})," Use square braces around chords: [C], [C#], [Cm] [Csus4], etc.",t.jsx("br",{}),"Click palette buttons or use ",t.jsx("strong",{children:"Ctrl+1-9, Ctrl+0"})," to insert chords at cursor."]})})]}),t.jsxs("div",{className:`preview-pane${D.length>0?" has-chord-ribbon":""}`,children:[t.jsx("h3",{children:"Preview"}),je()]})]}),t.jsxs("div",{className:"editor-actions-bottom",children:[t.jsx(oe,{type:"primary",icon:t.jsx(Qt,{}),onClick:Te,loading:ne,disabled:!i&&!o,size:"large","data-testid":o?"create-song-submit":"save-changes-submit",children:o?"Create Song":"Save Changes"}),t.jsx(oe,{icon:t.jsx(zt,{}),onClick:Ie,className:"cancel-btn",size:"large",children:"Cancel"})]})]})};function Ss({library:e,onSelectSong:s}){const[n,r]=u.useState(""),[a,i]=u.useState(new Set),[o,f]=u.useState(new Set),[x,N]=u.useState(null),C=u.useMemo(()=>{if(!e?.artists)return{artists:[]};const S=n.toLowerCase().trim();return S?{artists:e.artists.map(p=>{const P=p.name?.toLowerCase().includes(S),_=(p.albums||[]).map(E=>{const M=E.title?.toLowerCase().includes(S),A=(E.songs||[]).filter(K=>K.title?.toLowerCase().includes(S));return M||A.length>0?{...E,songs:M?E.songs:A}:null}).filter(Boolean);return P||_.length>0?{...p,albums:P?p.albums:_}:null}).filter(Boolean)}:e},[e,n]),d=u.useCallback(S=>{i(j=>{const p=new Set(j);return p.has(S)?p.delete(S):p.add(S),p})},[]),g=u.useCallback(S=>{f(j=>{const p=new Set(j);return p.has(S)?p.delete(S):p.add(S),p})},[]),b=u.useCallback((S,j,p)=>{const P=`${j}-${p}-${S.title}`;N(P),s&&s(S,j,p)},[s]);return t.jsxs(Bt,{sx:{width:"100%"},children:[t.jsx(Wt,{fullWidth:!0,variant:"outlined",size:"small",value:n,onChange:S=>r(S.target.value),placeholder:"Filter by song, artist, or album...",sx:{mb:2}}),t.jsx("div",{className:"song-tree",children:C.artists.length===0?t.jsx("div",{className:"song-tree-empty",children:n?"No songs found matching your search.":"No songs available."}):C.artists.map(S=>{const j=a.has(S.name);return t.jsxs("div",{className:"tree-artist",children:[t.jsxs("div",{className:"tree-node tree-artist-node",onClick:()=>d(S.name),children:[t.jsx("span",{className:"tree-toggle",children:S.albums?.length>0?j?"â–¼":"â–¶":"â€¢"}),t.jsx("span",{className:"tree-artist-name",children:S.name}),t.jsxs("span",{className:"tree-count",children:["(",S.albums?.length||0," albums)"]})]}),j&&t.jsx("div",{className:"tree-albums",style:{marginLeft:"20px"},children:(S.albums||[]).map(p=>{const P=`${S.name}-${p.title}`,_=o.has(P);return t.jsxs("div",{className:"tree-album",children:[t.jsxs("div",{className:"tree-node tree-album-node",onClick:()=>g(P),children:[t.jsx("span",{className:"tree-toggle",children:p.songs?.length>0?_?"â–¼":"â–¶":"â€¢"}),t.jsx("span",{className:"tree-album-title",children:p.title}),t.jsxs("span",{className:"tree-count",children:["(",p.songs?.length||0," songs)"]})]}),_&&t.jsx("div",{className:"tree-songs",children:(p.songs||[]).map(E=>{const M=`${S.name}-${p.title}-${E.title}`,A=x===M;return t.jsx("div",{className:`tree-node tree-song-node ${A?"selected":""}`,onClick:()=>b(E,S.name,p.title),children:t.jsxs("span",{className:"tree-song-text",children:["â™ª ",E.title]})},M)})})]},P)})})]},S.name)})})]})}function vs({library:e,selectedSong:s,editingEnabled:n,onSelectSong:r}){try{const a={libraryExists:!!e,hasArtists:!!e?.artists,artistCount:e?.artists?.length||0,totalSongs:e?.artists?e.artists.reduce((i,o)=>i+(o.albums||[]).reduce((f,x)=>f+(x.songs||[]).length,0),0):0,selectedSongExists:!!s,editingEnabled:n,libraryStructure:e?Object.keys(e):[]};console.log("ðŸŽµ SongListTest received props:",a),e?.artists&&e.artists.length>0?console.log("ðŸŽ¤ SongListTest first few artists:",e.artists.slice(0,3).map(i=>({name:i.name,albumCount:i.albums?.length||0,songCount:(i.albums||[]).reduce((o,f)=>o+(f.songs||[]).length,0)}))):console.log("âŒ SongListTest: No artists found in library")}catch(a){console.error("âŒ SongListTest: Error analyzing props:",a)}return t.jsx(Ss,{library:e,selectedSong:s,editingEnabled:n,onSelectSong:r})}function xs(){return ls({queryKey:["library","full"],queryFn:async()=>{console.log("ðŸš€ useLibraryQuery: Starting library fetch...");try{const e=await ye.loadLibrary();return console.log("ðŸ“š useLibraryQuery: Library loaded successfully:",{hasArtists:!!e?.artists,artistCount:e?.artists?.length||0,totalSongs:e?.artists?e.artists.reduce((s,n)=>s+(n.albums||[]).reduce((r,a)=>r+(a.songs||[]).length,0),0):0,libraryStructure:e?Object.keys(e):[]}),e}catch(e){throw console.error("âŒ useLibraryQuery: Failed to load library:",e),e}},staleTime:1e3*60,refetchOnWindowFocus:!1})}const ws=()=>{const{message:e}=Me.useApp(),s=tt();et();const n=ee(c=>c.songs.library),r=ee(c=>c.songs.selectedSong),a=ee(c=>c.songs.isGoogleDriveConnected),i=ee(c=>c.songs.userInfo),o=ee(c=>c.songs.isLoading),f=ee(c=>c.songs.error);ee(c=>c.library?.entries||[]);const x=ee(c=>c.library?.fullLibrary||null),{data:N,isLoading:C}=xs(),d=N||x,[g,b]=u.useState(!1),[S,j]=u.useState(!1),p=u.useCallback(()=>!n||!n.artists?0:n.artists.reduce((c,y)=>c+y.albums.reduce((O,$)=>O+($.songs?$.songs.length:0),0),0),[n]);u.useEffect(()=>{try{console.log("SongTabsApp observed songs store library change â€” artists=",n&&n.artists?n.artists.length:0)}catch{}},[n]);const P=u.useRef(null);u.useEffect(()=>{try{if(console.log("ðŸ”„ SongTabsApp fullLibrary effect triggered:",{fullLibraryPresent:!!d,fullLibraryHasArtists:!!d?.artists,fullLibraryArtistCount:d?.artists?.length||0,reduxLibraryHasArtists:!!n?.artists,reduxLibraryArtistCount:n?.artists?.length||0,fullLibraryStructure:d?Object.keys(d):[],reduxLibraryStructure:n?Object.keys(n):[]}),d&&d.artists&&Array.isArray(d.artists)){const c=JSON.stringify(d.artists);if(P.current===c){console.log("ðŸ“‹ Full library already applied to songs store (no-op)");return}const y=n?.artists?.length||0,O=d.artists.length;console.log("ðŸ”„ Overwriting Redux songs store from Drive library:",{existingArtists:y,newArtists:O,firstFewArtists:d.artists.slice(0,3).map($=>({name:$.name,albumCount:$.albums?.length||0,totalSongs:($.albums||[]).reduce((Z,te)=>Z+(te.songs||[]).length,0)}))}),s(bt({artists:d.artists}));try{s(St(d)),console.log("ðŸ“š Successfully set full library into library slice")}catch($){console.warn("âš ï¸ Failed to set full library into library slice:",$)}P.current=c,console.log("âœ… Songs store successfully overwritten from fullLibrary (Drive)")}else d?console.log("âš ï¸ fullLibrary present but no artists array found:",{fullLibrary:d,hasArtists:!!d?.artists,artistsType:typeof d?.artists,isArray:Array.isArray(d?.artists)}):console.log("âŒ No fullLibrary data available yet")}catch(c){console.error("Error applying fullLibrary to songs store:",c)}},[d,n,s]);const _=u.useCallback(()=>{s(Be())},[s]),E=u.useCallback(async()=>{try{await s(vt()).unwrap(),console.log("Library loaded from Google Drive")}catch(c){console.error("Failed to load library from Google Drive:",c);let y="Failed to load library from Google Drive";typeof c=="string"?c.includes("User not signed in")?y="Please sign in to Google Drive to access your music library":c.includes("JSON")?y="Invalid JSON format in Google Drive library file":c.includes("401")?y="Google Drive authentication expired - please sign in again":c.includes("403")?y="Access denied to Google Drive - check permissions":c.includes("404")?y="Library file not found in Google Drive - will create new one":c.includes("500")?y="Google Drive server error - try again later":c.includes("Network Error")||c.includes("Failed to fetch")?y="Network error - check your internet connection":y=`Google Drive error: ${c}`:c?.message&&(y=`Error: ${c.message}`),console.error("Detailed error info:",{errorType:typeof c,errorMessage:c?.message||c,errorStack:c?.stack,timestamp:new Date().toISOString()}),D(c)||y.includes("sign in")||y.includes("authentication")?(e.error(y),s(he(!1)),s(me(null))):e.error(y),s(Be())}},[s,e]),M=async c=>{if(r)try{const y=r.artist.name,O=r.album.title,$=r.title;await s(He({artistName:y,albumTitle:O,songTitle:$,updatedSongData:c,isGoogleDriveConnected:a})).unwrap(),e.success("Song updated successfully")}catch(y){console.error("Failed to update song:",y),D(y)?(s(he(!1)),s(me(null)),e.error("Your Google Drive session has expired. Please sign in again to save changes.")):e.error("Failed to save song changes. Please try again.")}},A=async(c,y=null)=>{if(r)try{const O=y?.artist||r.artist.name,$=y?.album||r.album.title,Z=c.title||r.title;await s(He({artistName:r.artist.name,albumTitle:r.album.title,songTitle:r.title,updatedSongData:c,newArtistName:O,newAlbumTitle:$,newSongTitle:Z,isGoogleDriveConnected:a})).unwrap(),e.success("Song updated successfully"),b(!1)}catch(O){console.error("Failed to update song:",O),D(O)?(s(he(!1)),s(me(null)),e.error("Your Google Drive session has expired. Please sign in again to save changes.")):e.error("Failed to save song changes. Please try again.")}};u.useEffect(()=>{(()=>{const y=ye.getSignInStatus();y.isSignedIn?(s(he(!0)),s(me({email:y.userEmail,name:y.userName,picture:y.userPicture})),console.log("ðŸ”„ Synced Google Drive session status for:",y.userEmail)):(console.debug("ðŸ“­ No active Google Drive session found, loading mock library"),_())})()},[]);const K=async c=>{try{await ye.handleOAuthToken(c);const y=ye.getSignInStatus();s(he(!0)),s(me({email:y.userEmail,name:y.userName,picture:y.userPicture})),await E()}catch(y){console.error("Google Sign-In failed:",y),e.error("Failed to connect to Google Drive. Please try again.")}},R=c=>{console.error("Google Sign-In error:",c),e.error("Failed to sign in with Google. Please try again.")},F=async()=>{try{await ye.signOut(),s(he(!1)),s(me(null)),_()}catch(c){console.error("Failed to sign out:",c)}},G=async c=>{try{ye.updateSettings(c),e.success("Google Drive settings updated successfully"),a&&await E()}catch(y){console.error("Failed to update settings:",y),e.error("Failed to update Google Drive settings")}},{setMenuItems:Q}=xt();u.useEffect(()=>(Q([]),()=>Q([])),[Q,s]);const L=$e.useRef(null),U=$e.useCallback((c,y,O)=>{if(c&&y&&O){const $={...c,title:c.title,artist:{name:y},album:{title:O}};s(We($)),setTimeout(()=>{L.current?L.current.scrollIntoView({behavior:"smooth"}):window.scrollTo({top:0,behavior:"smooth"})},100),c.chordFingerings?s(Ke(c.chordFingerings)):s(Ke({}))}},[s]),D=c=>{if(!c)return!1;const y=c.message||c||"";return["User not signed in to Google Drive","Expected OAuth 2 access token","login cookie or other valid authentication credential","Invalid Credentials","Authentication failed","unauthorized_client","invalid_token","expired_token","access_denied","token_expired","Request had invalid authentication credentials"].some($=>y.toLowerCase().includes($.toLowerCase()))},W=c=>{s(Ct(c))},ne=()=>{j(!0)},V=async c=>{try{const{title:y,artist:O,album:$,lyrics:Z}=c,te=n.artists?.find(Y=>Y.name===O);te||await s(jt({artistName:O,isGoogleDriveConnected:a})).unwrap(),(n.artists?.find(Y=>Y.name===O)||te)?.albums?.find(Y=>Y.title===$)||await s(At({artistName:O,albumTitle:$,isGoogleDriveConnected:a})).unwrap(),await s(Nt({artistName:O,albumTitle:$,songData:{title:y,lyrics:Z||"",notes:"",chords:""},isGoogleDriveConnected:a})).unwrap();const fe=n.artists?.find(Y=>Y.name===O)?.albums?.find(Y=>Y.title===$)?.songs?.find(Y=>Y.title===y);fe&&U(fe,O,$),j(!1),e.success("Song created successfully!")}catch(y){console.error("Failed to create song:",y),e.error("Failed to create song. Please try again.")}},X=async()=>{try{await s(rt({artistName:r.artist?.name,albumTitle:r.album?.title,songTitle:r.title,isGoogleDriveConnected:a})).unwrap(),s(We(null)),e.success("Song deleted successfully!")}catch(c){console.error("Failed to delete song:",c),e.error("Failed to delete song. Please try again.")}};return t.jsxs("div",{className:"song-tabs-app",children:[t.jsxs("div",{className:`songs-content-vertical ${g||S?"mode-full":""}`,children:[r&&t.jsx("div",{className:"selected-song-section",children:g?t.jsx(Xe,{song:r,artist:r.artist,album:r.album,onSave:A,onCancel:()=>b(!1),isGoogleDriveConnected:a,lyricsRef:L}):t.jsxs("div",{className:"song-view-body",children:[t.jsxs("div",{className:"song-view-header",children:[t.jsx(ys,{artist:r.artist?.name,album:r.album?.title}),t.jsxs("div",{className:"song-view-header-main",children:[t.jsxs("div",{className:"song-title-row",children:[t.jsx("h2",{className:"song-title",children:r.title}),a&&t.jsxs(t.Fragment,{children:[t.jsx(oe,{type:"text",size:"small",onClick:()=>b(!0),className:"song-action-button edit",title:"Edit Song",children:"âœï¸"}),t.jsx(Kt,{title:"Delete Song",description:`Are you sure you want to delete "${r.title}"? This action cannot be undone.`,onConfirm:X,okText:"Yes, Delete",cancelText:"Cancel",okType:"danger",children:t.jsx(oe,{type:"text",size:"small",className:"song-action-button delete",title:"Delete Song",children:"ðŸ—‘ï¸"})})]})]}),t.jsxs("p",{className:"song-subtitle",children:[r.artist?.name," - ",r.album?.title]})]}),t.jsx("div",{className:"song-action-column",children:t.jsx(oe,{onClick:()=>{const c=document.querySelector(".song-library-section");c&&c.scrollIntoView({behavior:"smooth"})},className:"scroll-library-button",children:"ðŸ“š Scroll to Song Library"})})]}),t.jsx("div",{className:"song-detail-wrapper",children:t.jsx(us,{song:r,artist:r.artist,album:r.album,editingEnabled:!1,onUpdateSong:M,onPinChord:W})})]})}),S&&t.jsx("div",{className:"new-song-section",children:t.jsx(Xe,{song:{lyrics:""},artist:{name:""},album:{title:""},onSave:V,onCancel:()=>j(!1),isGoogleDriveConnected:a,isNewSong:!0,library:n,lyricsRef:L})}),!g&&!S&&t.jsxs("div",{className:`song-library-section ${r?"has-selected-song":"no-selected-song"}`,children:[t.jsx(Ht,{appName:"Songs",isGoogleDriveConnected:a,userInfo:i,onSignIn:K,onSignOut:F,onSettingsChange:G,primaryAction:{label:"Add Song",onClick:ne,style:{backgroundColor:"#4CAF50",borderColor:"#4CAF50"}},libraryInfo:{title:"Songs",emoji:"ðŸŽµ",count:p(),isLoading:o},googleSignInProps:{onError:R,disabled:o},className:"songs-navigation"}),t.jsx(vs,{library:n,onSelectSong:U,selectedSong:r,editingEnabled:a})]}),!r&&!S&&t.jsx("div",{className:"empty-state",children:t.jsx("p",{children:"Select a song from your library above to see its chord chart and lyrics."})})]}),f&&t.jsxs("div",{className:"error-message",children:["Error: ",f,t.jsx(oe,{size:"small",onClick:()=>s(wt()),className:"dismiss-error-button",children:"Dismiss"})]})]})},Ns=()=>t.jsx(Me,{children:t.jsx(ws,{})});export{Ns as default};
//# sourceMappingURL=SongTabsAppModern-Di29tem4.js.map
